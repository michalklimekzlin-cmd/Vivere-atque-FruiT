<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Revia ‚Ä¢ Vivere atque FruiT</title>

    <!-- Styl Revie -->
    <link rel="stylesheet" href="./revia.css?v=0.75" />

    <!-- Jemn√© nastaven√≠ pozad√≠ (m≈Ø≈æe≈° klidnƒõ nechat) -->
    <style>
      body {
        background-size: auto 70vh;
        background-position: center 18vh;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-color: #000;
      }
      @media (max-height: 820px) {
        body {
          background-size: auto 68vh;
          background-position: center 20vh;
        }
      }
      @media (min-height: 900px) {
        body {
          background-size: auto 78vh;
          background-position: center 15vh;
        }
      }
      @media (max-width: 480px) {
        body {
          background-size: auto 88vh;
          background-position: center 0;
        }
      }
    </style>
  </head>

  <body>
    <!-- Hlavn√≠ wrapper Revie -->
    <div
      class="revia-main"
      id="reviaMain"
      data-mode="angel"
      data-control="ai"
    >
      <!-- horn√≠ li≈°ta -->
      <div class="revia-topbar">
        <!-- k≈ô√≠dlo = z√°pisn√≠k / PROGRAM -->
        <button
          class="revia-wing"
          id="revWing"
          type="button"
          aria-label="otev≈ô√≠t z√°pisn√≠k"
        ></button>

        <div class="revia-title">Revia</div>
        <div class="revia-state" id="revState">AI: hl√≠d√°m svƒõt</div>
      </div>

      <!-- z√°pisn√≠k ‚Äì tady p√≠≈°e≈° ‚Äûprogramovac√≠ text‚Äú pro Revii -->
      <div class="revia-notes" id="revNotes">
        <div class="notes-head">
          <span>‚úß K≈ô√≠dlo / program</span>
          <button id="notesClose" type="button">√ó</button>
        </div>
        <textarea
          id="notesText"
          placeholder="Sem napi≈° PROGRAM pro Revii ‚Äì jak se m√° chovat, mluvit, co hl√≠dat‚Ä¶"
        ></textarea>
        <p class="notes-foot">
          Ukl√°d√° se jen do tohoto za≈ô√≠zen√≠. Ka≈æd√Ω dotaz v chatu pou≈æ√≠v√° tenhle program.
        </p>
      </div>

      <!-- m≈ô√≠≈æka slot≈Ø (dovednosti) -->
      <div class="revia-card">
        <!-- SLOT 1: port√°l do Centra (hlavn√≠ index) -->
        <button
          class="revia-slot active"
          id="slotPortal"
          type="button"
          aria-label="Otev≈ô√≠t Vivere atque FruiT ‚Ä¢ Revia &amp; Centrum"
        >
          <span class="revia-glyph" id="slotPortalGlyph">Ÿã&‚Äô„Äç</span>
        </button>

        <!-- SLOT 2: Vstoupit / CHAT REVIA -->
<!-- SLOT 2: Vstoupit / CHAT REVIA -->
<button
  class="revia-slot"
  id="slotEnter"
  type="button"
  aria-label="Otev≈ô√≠t chat s Revi√≠"
>
  <span class="revia-glyph" id="slotEnterGlyph">{*(¬∞‚Ä¢.)(.‚Ä¢¬∞)*}//</span>
</button>

        <!-- SLOT 3: P≈ôepnout AI / Human (bez textu) -->
        <button
          class="revia-slot"
          id="slotControl"
          type="button"
          aria-label="P≈ôepnout ≈ô√≠zen√≠ mezi AI a Human"
        ></button>

        <!-- SLOT 4: Andƒõl ‚ù§Ô∏è / ƒé√°bel ‚òÜ ‚Äì p≈ôep√≠n√° m√≥d svƒõta -->
        <button
          class="revia-slot"
          id="slotMode"
          type="button"
          aria-label="P≈ôepnout Revia m√≥d andƒõl / ƒè√°bel"
        >
          <span class="revia-glyph" id="slotModeGlyph">„Äåƒ™‚Äô‚ô°</span>
        </button>

        <!-- SLOT 5: Rezerva (zat√≠m info) -->
        <button
          class="revia-slot"
          id="slotWorld"
          type="button"
          aria-label="Budouc√≠ svƒõtov√Ω modul"
        ></button>

        <!-- SLOT 6: Rezerva (zat√≠m info) -->
        <button
          class="revia-slot"
          id="slotExtra"
          type="button"
          aria-label="Budouc√≠ speci√°ln√≠ dovednost"
        ></button>
      </div>

      <!-- CHAT PANEL REVIE -->
      <div class="revia-chat" id="revChat">
        <div class="revia-chat-panel">
          <div class="revchat-head">
            <span id="revChatTitle">Revia ‚Ä¢ andƒõlsk√Ω re≈æim</span>
            <button id="revChatClose" type="button">√ó</button>
          </div>

          <div id="revChatLog" class="revchat-log"></div>

          <div class="revchat-input-row">
            <textarea
              id="revChatInput"
              placeholder="Zeptej se Revie‚Ä¶"
            ></textarea>
            <button id="revChatSend" type="button">Poslat</button>
          </div>

          <p class="revchat-note">
            Revia pou≈æ√≠v√° OpenAI p≈ôes backend. Historie chatu se ukl√°d√° jen do
            tohoto za≈ô√≠zen√≠ a do AI pos√≠l√°me jen posledn√≠ch p√°r zpr√°v + program z k≈ô√≠dla
            (≈°et≈ô√≠me tokeny).
          </p>
        </div>
      </div>

      <!-- spodn√≠ toast (mal√© hl√°≈°ky) -->
      <div class="revia-toast" id="revToast" aria-live="polite"></div>
    </div>

    <script>
      // Pomocn√° funkce pro toast ‚Äì pou≈æ√≠v√° t≈ô√≠du "show"
      function showToast(message) {
        const toast = document.getElementById("revToast");
        if (!toast) return;
        toast.textContent = message;
        toast.classList.add("show");
        clearTimeout(toast._hideTimer);
        toast._hideTimer = setTimeout(() => {
          toast.classList.remove("show");
        }, 2200);
      }

      // ========== Z√ÅPISN√çK (k≈ô√≠dlo / PROGRAM) ==========
      (function () {
        const wing = document.getElementById("revWing");
        const notes = document.getElementById("revNotes");
        const closeBtn = document.getElementById("notesClose");
        const textarea = document.getElementById("notesText");
        const STORAGE_KEY = "revia-notes-v1";

        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) textarea.value = saved;
        } catch (e) {}

        function openNotes() {
          notes.classList.add("open");
        }

        function closeNotes() {
          notes.classList.remove("open");
        }

        if (wing) wing.addEventListener("click", openNotes);
        if (closeBtn) closeBtn.addEventListener("click", closeNotes);

        if (textarea) {
          textarea.addEventListener("input", () => {
            try {
              localStorage.setItem(STORAGE_KEY, textarea.value || "");
            } catch (e) {}
          });
        }
      })();

      // ========== SLOT 1 ‚Äì port√°l do Centra ==========
      (function () {
        const slotPortal = document.getElementById("slotPortal");
        if (!slotPortal) return;
        slotPortal.addEventListener("click", () => {
          showToast("Otev√≠r√°m Vivere atque FruiT ‚Ä¢ Revia & Centrum‚Ä¶");
          window.location.href = "../index.html";
        });
      })();

      // ========== SLOT 3 ‚Äì P≈ôepnout AI / Human ==========
      (function () {
        const main = document.getElementById("reviaMain");
        const state = document.getElementById("revState");
        const slotControl = document.getElementById("slotControl");

        if (!main || !state || !slotControl) return;

        function updateState() {
          const mode = main.getAttribute("data-control") || "ai";
          if (mode === "ai") {
            state.textContent = "AI: hl√≠d√°m svƒõt";
          } else {
            state.textContent = "Human: p≈ôeb√≠r√°m ≈ô√≠zen√≠";
          }
        }

        updateState();

        slotControl.addEventListener("click", () => {
          const current = main.getAttribute("data-control") || "ai";
          const next = current === "ai" ? "human" : "ai";
          main.setAttribute("data-control", next);
          updateState();

          if (next === "ai") {
            showToast("Revia ≈ô√≠zen√≠ vrac√≠ AI, ty jen hl√≠dej, jak se svƒõt chov√°.");
          } else {
            showToast("Revia d√°v√° ≈ô√≠zen√≠ tobƒõ. Svƒõt se p≈ôizp≈Øsob√≠ tobƒõ.");
          }
        });
      })();

      // ========== SLOT 4 ‚Äì Andƒõl / ƒé√°bel ==========
      (function () {
        const main = document.getElementById("reviaMain");
        const glyph = document.getElementById("slotModeGlyph");
        const slotMode = document.getElementById("slotMode");
        const chatTitle = document.getElementById("revChatTitle");

        if (!main || !glyph || !slotMode) return;

        function setAngel() {
          main.setAttribute("data-mode", "angel");
          glyph.textContent = "„Äåƒ™‚Äô‚ô°";
          if (chatTitle) chatTitle.textContent = "Revia ‚Ä¢ andƒõlsk√Ω re≈æim";
          showToast("Revia p≈ôepnuta do andƒõlsk√©ho re≈æimu (hl√≠d√° svƒõt jemnƒõji).");
        }

        function setDaemon() {
          main.setAttribute("data-mode", "daemon");
          glyph.textContent = "„Äåƒ™‚Äô‚òÜ";
          if (chatTitle) chatTitle.textContent = "Revia ‚Ä¢ ƒè√°belsk√Ω re≈æim";
          showToast("Revia p≈ôepnuta do ƒè√°belsk√©ho re≈æimu (p≈ô√≠snƒõj≈°√≠ dohled).");
        }

        // v√Ωchoz√≠ stav ‚Äì andƒõl
        setAngel();

        slotMode.addEventListener("click", () => {
          const mode = main.getAttribute("data-mode") || "angel";
          if (mode === "angel") {
            setDaemon();
          } else {
            setAngel();
          }
        });
      })();

      // ========== SLOT 5 + 6 ‚Äì placeholdery ==========
      (function () {
        const world = document.getElementById("slotWorld");
        const extra = document.getElementById("slotExtra");

        if (world) {
          world.addEventListener("click", () => {
            showToast("Tady bude pozdƒõji p≈ô√≠m√Ω vstup na nƒõkter√Ω z VaFT svƒõt≈Ø.");
          });
        }

        if (extra) {
          extra.addEventListener("click", () => {
            showToast("Rezervovan√Ω slot pro budouc√≠ speci√°ln√≠ dovednost Revie.");
          });
        }
      })();

// ========== CHAT REVIE ‚Äì SLOT 2 ==========
(function () {
  const main = document.getElementById("reviaMain");
  const slotEnter = document.getElementById("slotEnter");
  const glyphEnter = document.getElementById("slotEnterGlyph");
  const chat = document.getElementById("revChat");
  const closeBtn = document.getElementById("revChatClose");
  const sendBtn = document.getElementById("revChatSend");
  const input = document.getElementById("revChatInput");
  const log = document.getElementById("revChatLog");
  const STORAGE_KEY = "revia.chat.history.v1";

  if (!slotEnter || !chat || !sendBtn || !input || !log) return;

  // üîÅ P≈ôep√≠n√°n√≠ glyphu: {*(¬∞‚Ä¢.)(.‚Ä¢¬∞)*}// <-> {(¬∞‚Ä¢.)(.‚Ä¢¬∞)}
  function toggleGlyph() {
    if (!glyphEnter) return;
    const current = glyphEnter.textContent || "";
    if (current.includes("*")) {
      glyphEnter.textContent = "{(¬∞‚Ä¢.)(.‚Ä¢¬∞)}";
    } else {
      glyphEnter.textContent = "{*(¬∞‚Ä¢.)(.‚Ä¢¬∞)*}//";
    }
  }

  let history = [];
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) history = JSON.parse(raw);
  } catch (e) {
    history = [];
  }

  function saveHistory() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    } catch (e) {}
  }

  function addMessage(role, content) {
    history.push({
      role,
      content,
      time: new Date().toLocaleTimeString("cs-CZ", {
        hour: "2-digit",
        minute: "2-digit",
      }),
    });
    if (history.length > 30) {
      history = history.slice(history.length - 30);
    }
    saveHistory();
    renderLog();
  }

  function renderLog() {
    log.innerHTML = "";
    history.forEach((m) => {
      const row = document.createElement("div");
      row.className =
        "revchat-msg " +
        (m.role === "user" ? "revchat-user" : "revchat-bot");
      const name = m.role === "user" ? "Ty" : "Revia";
      row.innerHTML =
        "<small>" +
        name +
        " ‚Ä¢ " +
        (m.time || "") +
        "</small><br>" +
        m.content;
      log.appendChild(row);
    });
    log.scrollTop = log.scrollHeight;
  }

  function openChat() {
    chat.classList.add("is-open");
    renderLog();
    input.focus();
  }

  function closeChat() {
    chat.classList.remove("is-open");
  }

  slotEnter.addEventListener("click", () => {
    toggleGlyph();
    openChat();
  });

  if (closeBtn) {
    closeBtn.addEventListener("click", closeChat);
  }

  async function handleSend() {
    const text = (input.value || "").trim();
    if (!text) return;
    input.value = "";
    addMessage("user", text);

    const mode = main?.getAttribute("data-mode") || "angel";

    const backendMessages = history.slice(-8).map((m) => ({
      role: m.role === "user" ? "user" : "assistant",
      content: m.content,
    }));

    try {
      showToast("Revia p≈ôem√Ω≈°l√≠‚Ä¶");
      const resp = await fetch("/api/revia-chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          messages: backendMessages,
          mode,
        }),
      });

      if (!resp.ok) {
        addMessage(
          "assistant",
          "Spojen√≠ s Revii backendem spadlo. Zkus to je≈°tƒõ jednou."
        );
        return;
      }

      const data = await resp.json();
      const reply =
        (data && data.reply) ||
        "Dneska jsem trochu tich√°, ale jsem tu s tebou.";
      addMessage("assistant", reply);
    } catch (e) {
      console.error(e);
      addMessage(
        "assistant",
        "Nƒõco se pokazilo na cestƒõ k AI. Zkus to pros√≠m pozdƒõji."
      );
    }
  }

  sendBtn.addEventListener("click", handleSend);

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });

  if (history.length === 0) {
    addMessage(
      "assistant",
      "Jsem Revia. Hl√≠d√°m tv≈Øj svƒõt Vivere atque FruiT. Zeptej se mƒõ na cokoliv, co m√°≈° teƒè v hlavƒõ."
    );
  } else {
    renderLog();
  }
})();

        function renderLog() {
          log.innerHTML = "";
          history.forEach((m) => {
            const row = document.createElement("div");
            row.className =
              "revchat-msg " +
              (m.role === "user" ? "revchat-user" : "revchat-bot");
            const name = m.role === "user" ? "Ty" : "Revia";
            row.innerHTML =
              "<small>" +
              name +
              " ‚Ä¢ " +
              (m.time || "") +
              "</small><br>" +
              m.content;
            log.appendChild(row);
          });
          log.scrollTop = log.scrollHeight;
        }

        function openChat() {
          chat.classList.add("is-open");
          renderLog();
          input.focus();
        }

        function closeChat() {
          chat.classList.remove("is-open");
        }

        slotEnter.addEventListener("click", () => {
          openChat();
        });

        if (closeBtn) {
          closeBtn.addEventListener("click", closeChat);
        }

        async function handleSend() {
          const text = (input.value || "").trim();
          if (!text) return;
          input.value = "";
          addMessage("user", text);

          const mode = main?.getAttribute("data-mode") || "angel";

          // üÜï p≈ôeƒçteme PROGRAM z k≈ô√≠dla
          const persona =
            document.getElementById("notesText")?.value || "";

          // p≈ôiprav√≠me kr√°tkou historii pro backend (jen posledn√≠ch 8 zpr√°v)
          const backendMessages = history.slice(-8).map((m) => ({
            role: m.role === "user" ? "user" : "assistant",
            content: m.content,
          }));

          try {
            showToast("Revia p≈ôem√Ω≈°l√≠‚Ä¶");
            const resp = await fetch("/api/revia-chat", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                messages: backendMessages,
                mode,
                persona, // üÜï program z k≈ô√≠dla
              }),
            });

            if (!resp.ok) {
              addMessage(
                "assistant",
                "Spojen√≠ s Revii backendem spadlo. Zkus to je≈°tƒõ jednou."
              );
              return;
            }

            const data = await resp.json();
            const reply =
              (data && data.reply) ||
              "Dneska jsem trochu tich√°, ale jsem tu s tebou.";
            addMessage("assistant", reply);
          } catch (e) {
            console.error(e);
            addMessage(
              "assistant",
              "Nƒõco se pokazilo na cestƒõ k AI. Zkus to pros√≠m pozdƒõji."
            );
          }
        }

        sendBtn.addEventListener("click", handleSend);

        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            handleSend();
          }
        });

        // prvn√≠ zpr√°va, pokud je historie pr√°zdn√°
        if (history.length === 0) {
          addMessage(
            "assistant",
            "Jsem Revia. Hl√≠d√°m tv≈Øj svƒõt Vivere atque FruiT. Zeptej se mƒõ na cokoliv, co m√°≈° teƒè v hlavƒõ."
          );
        } else {
          renderLog();
        }
      })();
    </script>
  </body>
</html>
