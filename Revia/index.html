<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Revia • Vivere atque FruiT</title>

    <!-- Styl Revie -->
    <link rel="stylesheet" href="./revia.css?v=0.75" />

    <!-- Jemné nastavení pozadí (můžeš klidně nechat) -->
    <style>
      body {
        background-size: auto 70vh;
        background-position: center 18vh;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-color: #000;
      }
      @media (max-height: 820px) {
        body {
          background-size: auto 68vh;
          background-position: center 20vh;
        }
      }
      @media (min-height: 900px) {
        body {
          background-size: auto 78vh;
          background-position: center 15vh;
        }
      }
      @media (max-width: 480px) {
        body {
          background-size: auto 88vh;
          background-position: center 0;
        }
      }
    </style>
  </head>

  <body>
    <!-- Hlavní wrapper Revie -->
    <div
      class="revia-main"
      id="reviaMain"
      data-mode="angel"
      data-control="ai"
    >
      <!-- horní lišta -->
      <div class="revia-topbar">
        <!-- křídlo = zápisník -->
        <button
          class="revia-wing"
          id="revWing"
          type="button"
          aria-label="otevřít zápisník"
        ></button>

        <div class="revia-title">Revia</div>
        <div class="revia-state" id="revState">AI: hlídám svět</div>
      </div>

      <!-- zápisník -->
      <div class="revia-notes" id="revNotes">
        <div class="notes-head">
          <span>✧ Křídlo / zápis</span>
          <button id="notesClose" type="button">×</button>
        </div>
        <textarea
          id="notesText"
          placeholder="Charakter, úkoly, komu se ukáže…"
        ></textarea>
        <p class="notes-foot">Ukládá se jen do tohoto zařízení.</p>
      </div>

      <!-- mřížka slotů (dovednosti) -->
      <div class="revia-card">
        <!-- SLOT 1: portál do Centra (hlavní index) -->
        <button
          class="revia-slot active"
          id="slotPortal"
          type="button"
          aria-label="Otevřít Vivere atque FruiT • Revia &amp; Centrum"
        >
          <span class="revia-glyph" id="slotPortalGlyph">ً&’」</span>
        </button>

        <!-- SLOT 2: Vstoupit / CHAT REVIA -->
        <button
          class="revia-slot"
          id="slotEnter"
          type="button"
          aria-label="Otevřít chat s Revií"
        ></button>

        <!-- SLOT 3: Přepnout AI / Human (bez textu) -->
        <button
          class="revia-slot"
          id="slotControl"
          type="button"
          aria-label="Přepnout řízení mezi AI a Human"
        ></button>

        <!-- SLOT 4: Anděl ❤️ / Ďábel ☆ – přepíná mód světa -->
        <button
          class="revia-slot"
          id="slotMode"
          type="button"
          aria-label="Přepnout Revia mód anděl / ďábel"
        >
          <span class="revia-glyph" id="slotModeGlyph">「Ī’♡</span>
        </button>

        <!-- SLOT 5: Rezerva (zatím info) -->
        <button
          class="revia-slot"
          id="slotWorld"
          type="button"
          aria-label="Budoucí světový modul"
        ></button>

        <!-- SLOT 6: Rezerva (zatím info) -->
        <button
          class="revia-slot"
          id="slotExtra"
          type="button"
          aria-label="Budoucí speciální dovednost"
        ></button>
      </div>

      <!-- CHAT PANEL REVIE -->
      <div class="revia-chat" id="revChat">
        <div class="revia-chat-panel">
          <div class="revchat-head">
            <span id="revChatTitle">Revia • andělský režim</span>
            <button id="revChatClose" type="button">×</button>
          </div>

          <div id="revChatLog" class="revchat-log"></div>

          <div class="revchat-input-row">
            <textarea
              id="revChatInput"
              placeholder="Zeptej se Revie na hlídání světa, rady, cokoliv…"
            ></textarea>
            <button id="revChatSend" type="button">Poslat</button>
          </div>

          <p class="revchat-note">
            Revia používá OpenAI přes backend. Historie chatu se ukládá jen do
            tohoto zařízení a do AI posíláme jen posledních pár zpráv
            (šetření tokenů).
          </p>
        </div>
      </div>

      <!-- spodní toast (malé hlášky) -->
      <div class="revia-toast" id="revToast" aria-live="polite"></div>
    </div>

    <script>
      // Pomocná funkce pro toast – používá třídu "show"
      function showToast(message) {
        const toast = document.getElementById("revToast");
        if (!toast) return;
        toast.textContent = message;
        toast.classList.add("show");
        clearTimeout(toast._hideTimer);
        toast._hideTimer = setTimeout(() => {
          toast.classList.remove("show");
        }, 2200);
      }

      // ========== ZÁPISNÍK (křídlo) ==========
      (function () {
        const wing = document.getElementById("revWing");
        const notes = document.getElementById("revNotes");
        const closeBtn = document.getElementById("notesClose");
        const textarea = document.getElementById("notesText");
        const STORAGE_KEY = "revia-notes-v1";

        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) textarea.value = saved;
        } catch (e) {}

        function openNotes() {
          notes.classList.add("open");
        }

        function closeNotes() {
          notes.classList.remove("open");
        }

        if (wing) wing.addEventListener("click", openNotes);
        if (closeBtn) closeBtn.addEventListener("click", closeNotes);

        if (textarea) {
          textarea.addEventListener("input", () => {
            try {
              localStorage.setItem(STORAGE_KEY, textarea.value || "");
            } catch (e) {}
          });
        }
      })();

      // ========== SLOT 1 – portál do Centra ==========
      (function () {
        const slotPortal = document.getElementById("slotPortal");
        if (!slotPortal) return;
        slotPortal.addEventListener("click", () => {
          showToast("Otevírám Vivere atque FruiT • Revia & Centrum…");
          window.location.href = "../index.html";
        });
      })();

      // ========== SLOT 3 – Přepnout AI / Human ==========
      (function () {
        const main = document.getElementById("reviaMain");
        const state = document.getElementById("revState");
        const slotControl = document.getElementById("slotControl");

        if (!main || !state || !slotControl) return;

        function updateState() {
          const mode = main.getAttribute("data-control") || "ai";
          if (mode === "ai") {
            state.textContent = "AI: hlídám svět";
          } else {
            state.textContent = "Human: přebírám řízení";
          }
        }

        updateState();

        slotControl.addEventListener("click", () => {
          const current = main.getAttribute("data-control") || "ai";
          const next = current === "ai" ? "human" : "ai";
          main.setAttribute("data-control", next);
          updateState();

          if (next === "ai") {
            showToast("Revia řízení vrací AI, ty jen hlídej, jak se svět chová.");
          } else {
            showToast("Revia dává řízení tobě. Svět se přizpůsobí tobě.");
          }
        });
      })();

      // ========== SLOT 4 – Anděl / Ďábel ==========
      (function () {
        const main = document.getElementById("reviaMain");
        const glyph = document.getElementById("slotModeGlyph");
        const slotMode = document.getElementById("slotMode");
        const chatTitle = document.getElementById("revChatTitle");

        if (!main || !glyph || !slotMode) return;

        function setAngel() {
          main.setAttribute("data-mode", "angel");
          glyph.textContent = "「Ī’♡";
          if (chatTitle) chatTitle.textContent = "Revia • andělský režim";
          showToast("Revia přepnuta do andělského režimu (hlídá svět jemněji).");
        }

        function setDaemon() {
          main.setAttribute("data-mode", "daemon");
          glyph.textContent = "「Ī’☆";
          if (chatTitle) chatTitle.textContent = "Revia • ďábelský režim";
          showToast("Revia přepnuta do ďábelského režimu (přísnější dohled).");
        }

        // výchozí stav – anděl
        setAngel();

        slotMode.addEventListener("click", () => {
          const mode = main.getAttribute("data-mode") || "angel";
          if (mode === "angel") {
            setDaemon();
          } else {
            setAngel();
          }
        });
      })();

      // ========== SLOT 5 + 6 – placeholdery ==========
      (function () {
        const world = document.getElementById("slotWorld");
        const extra = document.getElementById("slotExtra");

        if (world) {
          world.addEventListener("click", () => {
            showToast("Tady bude později přímý vstup na některý z VaFT světů.");
          });
        }

        if (extra) {
          extra.addEventListener("click", () => {
            showToast("Rezervovaný slot pro budoucí speciální dovednost Revie.");
          });
        }
      })();

      // ========== CHAT REVIE – SLOT 2 + TOKENY ==========
      (function () {
        const main = document.getElementById("reviaMain");
        const slotEnter = document.getElementById("slotEnter");
        const chat = document.getElementById("revChat");
        const closeBtn = document.getElementById("revChatClose");
        const sendBtn = document.getElementById("revChatSend");
        const input = document.getElementById("revChatInput");
        const log = document.getElementById("revChatLog");
        const STORAGE_KEY = "revia.chat.history.v1";

        // ✦ tokenová peněženka
        const TOKEN_DAILY_LIMIT = 100000; // můžeš si později poladit
        const TOKEN_MONTHLY_LIMIT = 1000000;
        const USAGE_KEY = "revia.tokens.usage.v1";

        function loadUsage() {
          const now = new Date();
          const today = now.toISOString().slice(0, 10); // YYYY-MM-DD
          const monthKey =
            now.getFullYear() +
            "-" +
            String(now.getMonth() + 1).padStart(2, "0");

          try {
            const raw = localStorage.getItem(USAGE_KEY);
            if (!raw) {
              return { day: today, month: monthKey, usedToday: 0, usedMonth: 0 };
            }
            const parsed = JSON.parse(raw);

            if (parsed.day !== today) {
              parsed.day = today;
              parsed.usedToday = 0;
            }

            if (parsed.month !== monthKey) {
              parsed.month = monthKey;
              parsed.usedMonth = 0;
            }

            return parsed;
          } catch {
            return { day: today, month: monthKey, usedToday: 0, usedMonth: 0 };
          }
        }

        function saveUsage(usage) {
          try {
            localStorage.setItem(USAGE_KEY, JSON.stringify(usage));
          } catch {}
        }

        // odhad, kdyby usage z OpenAI nevrátilo nic
        function estimateTokensPerCall() {
          return 1200; // 0.7–1.5k je OK, můžeme časem přeladit
        }

        if (!slotEnter || !chat || !sendBtn || !input || !log) return;

        let history = [];
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) history = JSON.parse(raw);
        } catch (e) {
          history = [];
        }

        function saveHistory() {
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
          } catch (e) {}
        }

        function addMessage(role, content) {
          history.push({
            role,
            content,
            time: new Date().toLocaleTimeString("cs-CZ", {
              hour: "2-digit",
              minute: "2-digit",
            }),
          });

          // dlouhá paměť, ale ať se to úplně neurve – necháme max ~500
          if (history.length > 500) {
            history = history.slice(history.length - 500);
          }

          saveHistory();
          renderLog();
        }

        function renderLog() {
          log.innerHTML = "";
          history.forEach((m) => {
            const row = document.createElement("div");
            row.className =
              "revchat-msg " +
              (m.role === "user" ? "revchat-user" : "revchat-bot");
            const name = m.role === "user" ? "Ty" : "Revia";
            row.innerHTML =
              "<small>" +
              name +
              " • " +
              (m.time || "") +
              "</small><br>" +
              m.content;
            log.appendChild(row);
          });
          log.scrollTop = log.scrollHeight;
        }

        function openChat() {
          chat.classList.add("is-open");
          renderLog();
          input.focus();
        }

        function closeChat() {
          chat.classList.remove("is-open");
        }

        slotEnter.addEventListener("click", () => {
          openChat();
        });

        if (closeBtn) {
          closeBtn.addEventListener("click", closeChat);
        }

        async function handleSend() {
          const text = (input.value || "").trim();
          if (!text) return;
          input.value = "";
          addMessage("user", text);

          // ✦ tokenová peněženka – načtení stavu
          let usageState = loadUsage();
          const estimatedCost = estimateTokensPerCall();
          const softDaily = TOKEN_DAILY_LIMIT * 0.8;
          const softMonth = TOKEN_MONTHLY_LIMIT * 0.8;

          // tvrdý limit – Revia už dál „nejde“
          if (
            usageState.usedToday + estimatedCost > TOKEN_DAILY_LIMIT ||
            usageState.usedMonth + estimatedCost > TOKEN_MONTHLY_LIMIT
          ) {
            addMessage(
              "assistant",
              "Brácho… dneska jsem už vyčerpala svůj tokenový rozpočet. " +
                "Abych nevycucla účet, počkej prosím do dalšího resetu."
            );
            showToast(
              "Revia: Denní nebo měsíční limit tokenů je vyčerpaný."
            );
            return;
          }

          // měkké varování – blížíme se k limitu
          if (
            usageState.usedToday + estimatedCost > softDaily ||
            usageState.usedMonth + estimatedCost > softMonth
          ) {
            showToast(
              "Revia: Blížíme se tokenovému limitu, zkusme kratší zprávy."
            );
          }

          const mode = main?.getAttribute("data-mode") || "angel";

          // připravíme historii pro backend (jen posledních 50 zpráv)
          const backendMessages = history.slice(-50).map((m) => ({
            role: m.role === "user" ? "user" : "assistant",
            content: m.content,
          ));

          try {
            showToast("Revia přemýšlí…");
            const resp = await fetch("/api/revia-chat", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                messages: backendMessages,
                mode,
              }),
            });

            if (!resp.ok) {
              addMessage(
                "assistant",
                "Spojení s Revii backendem spadlo. Zkus to ještě jednou."
              );
              return;
            }

            const data = await resp.json();

            const reply =
              (data && data.reply) ||
              "Dneska jsem trochu tichá, ale jsem tu s tebou.";
            addMessage("assistant", reply);

            // přičtení skutečné spotřeby, pokud ji backend pošle
            try {
              if (
                data &&
                data.usage &&
                typeof data.usage.total_tokens === "number"
              ) {
                usageState = loadUsage();
                usageState.usedToday += data.usage.total_tokens;
                usageState.usedMonth += data.usage.total_tokens;
                saveUsage(usageState);

                if (usageState.usedToday > softDaily) {
                  showToast(
                    "Revia: Za dnešek jsem už použila ~" +
                      usageState.usedToday +
                      " tokenů. Ještě chvíli a dám si pauzu."
                  );
                }
              }
            } catch (e) {
              // když se to nepovede, nic se neděje
            }
          } catch (e) {
            console.error(e);
            addMessage(
              "assistant",
              "Něco se pokazilo na cestě k AI. Zkus to prosím později."
            );
          }
        }

        sendBtn.addEventListener("click", handleSend);

        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            handleSend();
          }
        });

        // první zpráva, pokud je historie prázdná
        if (history.length === 0) {
          addMessage(
            "assistant",
            "Jsem Revia. Hlídám tvůj svět Vivere atque FruiT. Zeptej se mě na cokoliv, co máš teď v hlavě."
          );
        } else {
          renderLog();
        }
      })();
    </script>
  </body>
</html>
