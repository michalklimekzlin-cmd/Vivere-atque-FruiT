<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Vivere atque FruiT • Mini RPG</title>
    <style>
      :root {
        --bg: #05060a;
        --bg-soft: #080a12;
        --line-world: #f4d7a1;
        --hero-vafit: #7fffd4;
        --hero-vivere: #a5fffe;
        --accent: #5be38a;
        --accent-soft: #1f2937;
        --text-soft: #adb5d6;
        --text-strong: #f9fafb;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at top, #0a0c18, #020309);
        color: var(--text-strong);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        overflow: hidden;
      }

      .root {
        position: fixed;
        inset: 0;
        display: flex;
        flex-direction: column;
      }

      /* TOP BAR */

      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        padding: 0.6rem 1.1rem 0.4rem;
        font-size: 0.8rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--text-soft);
      }

      .topbar-left {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .topbar-title {
        font-size: 0.8rem;
        color: var(--text-strong);
      }

      .topbar-sub {
        font-size: 0.7rem;
        opacity: 0.8;
      }

      .topbar-badge {
        padding: 0.18rem 0.6rem;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.5);
        font-size: 0.7rem;
        text-transform: uppercase;
      }

      /* MAIN */

      .main {
        position: relative;
        flex: 1;
        display: flex;
        padding: 0 0.6rem 0.4rem;
        gap: 0.6rem;
        box-sizing: border-box;
      }

      .world-wrapper {
        position: relative;
        flex: 1;
        border-radius: 32px;
        background: radial-gradient(circle at top, #06091a, #020208);
        box-shadow: 0 40px 90px rgba(0, 0, 0, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.05);
        overflow: hidden;
        min-height: 260px;
      }

      #world-canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        display: block;
        touch-action: none;
      }

      /* MINI MAPA */

      .minimap {
        position: absolute;
        top: 0.7rem;
        right: 0.7rem;
        width: 140px;
        height: 60px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.88);
        border: 1px solid rgba(148, 163, 184, 0.6);
        backdrop-filter: blur(16px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        padding: 0.35rem 0.5rem 0.4rem;
        box-sizing: border-box;
        pointer-events: none;
      }

      .minimap-label {
        font-size: 0.63rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--text-soft);
        margin-bottom: 0.25rem;
      }

      #minimap-canvas {
        flex: 1;
        width: 100%;
        border-radius: 999px;
      }

      /* HUD BOTTOM */

      .hud-bottom {
        display: flex;
        justify-content: space-between;
        align-items: stretch;
        padding: 0.5rem 0.9rem 0.7rem;
        gap: 0.8rem;
        font-size: 0.75rem;
        color: var(--text-soft);
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .controls-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.14em;
      }

      .arrow-grid {
        display: grid;
        grid-template-columns: repeat(3, 30px);
        grid-template-rows: repeat(3, 30px);
        gap: 0.18rem;
      }

      .btn-arrow {
        border-radius: 10px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: radial-gradient(circle at top, #0b1220, #020617);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        color: var(--text-strong);
        cursor: pointer;
        user-select: none;
        touch-action: manipulation;
      }

      .btn-arrow.empty {
        border: none;
        background: transparent;
        pointer-events: none;
      }

      .btn-arrow:active {
        transform: translateY(1px) scale(0.98);
        background: radial-gradient(circle at top, #111827, #020617);
      }

      .hud-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.35rem;
        text-align: right;
      }

      .hero-toggle {
        display: inline-flex;
        padding: 0.12rem;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.5);
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.7);
      }

      .hero-toggle button {
        border: none;
        padding: 0.26rem 0.7rem;
        border-radius: 999px;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        background: transparent;
        color: var(--text-soft);
        cursor: pointer;
        user-select: none;
      }

      .hero-toggle button.active {
        background: radial-gradient(circle at top, #22c55e, #15803d);
        color: #ecfdf5;
        box-shadow: 0 0 0 1px rgba(74, 222, 128, 0.8);
      }

      /* SMĚROVÝ KURZOR */

      .dir-box {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.12rem;
      }

      .dir-label {
        font-size: 0.62rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: rgba(148, 163, 184, 0.9);
      }

      .dir-circle {
        position: relative;
        width: 46px;
        height: 46px;
        border-radius: 50%;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: radial-gradient(circle at top, #020617, #02010a);
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.75);
      }

      #dir-arrow {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 2px;
        height: 16px;
        background: #5be38a;
        border-radius: 999px 999px 2px 2px;
        transform-origin: 50% 90%;
        transform: translate(-50%, -50%) rotate(0rad);
        opacity: 0.25;
        transition: opacity 0.15s ease-out;
      }

      #dir-arrow::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 72%;
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: #5be38a;
        transform: translate(-50%, -50%);
      }

      .hud-tip {
        font-size: 0.65rem;
        opacity: 0.9;
        max-width: 260px;
      }

      .hud-world-label {
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: rgba(148, 163, 184, 0.85);
      }

      .hud-world-label span {
        color: var(--accent);
      }

      @media (max-width: 768px) {
        .main {
          padding-inline: 0.4rem;
        }

        .world-wrapper {
          border-radius: 24px;
        }

        .hud-bottom {
          padding-inline: 0.6rem;
        }

        .hud-tip {
          max-width: 200px;
        }
      }

      @media (max-width: 600px) {
        .hud-bottom {
          flex-direction: column;
          align-items: stretch;
        }

        .hud-right {
          align-items: flex-start;
          text-align: left;
        }

        .dir-box {
          align-items: flex-start;
        }

        .hud-world-label {
          text-align: left;
        }
      }
    </style>
  </head>

  <body>
    <div class="root">
      <div class="topbar">
        <div class="topbar-left">
          <div class="topbar-title">Vivere atque Fruit • Mini RPG</div>
          <div class="topbar-sub">
            Kostka = svět, VaFIT + Vivere = parťáci uvnitř.
          </div>
        </div>
        <div class="topbar-badge">(Level 0 • Test světy)</div>
      </div>

      <div class="main">
        <div class="world-wrapper">
          <canvas id="world-canvas"></canvas>

          <div class="minimap">
            <div class="minimap-label">Mini mapa světů</div>
            <canvas id="minimap-canvas"></canvas>
          </div>
        </div>
      </div>

      <div class="hud-bottom">
        <div class="controls">
          <div class="controls-label">Ovládání pohybu</div>
          <div class="arrow-grid">
            <div class="btn-arrow empty"></div>
            <button class="btn-arrow" data-dir="up">▲</button>
            <div class="btn-arrow empty"></div>

            <button class="btn-arrow" data-dir="left">◀</button>
            <div class="btn-arrow empty"></div>
            <button class="btn-arrow" data-dir="right">▶</button>

            <div class="btn-arrow empty"></div>
            <button class="btn-arrow" data-dir="down">▼</button>
            <div class="btn-arrow empty"></div>
          </div>
        </div>

        <div class="hud-right">
          <div class="hero-toggle">
            <button id="btn-vafit" class="active">VaFIT (Panáček)</button>
            <button id="btn-vivere">Vivere (Mráček)</button>
          </div>

          <div class="dir-box">
            <div class="dir-label">Směr chůze</div>
            <div class="dir-circle">
              <div id="dir-arrow"></div>
            </div>
          </div>

          <div class="hud-tip">
            Šipky / WASD hýbou postavou. Prstem / myší otáčíš kameru, dvěma
            prsty přibližuješ. Přechod mezi krychlemi je u středního portálu.
          </div>
          <div class="hud-world-label">
            Aktuální svět: <span id="world-label">Kostka (Svět 1)</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ----- CANVAS SETUP -----
      const canvas = document.getElementById("world-canvas");
      const ctx = canvas.getContext("2d");
      const mmCanvas = document.getElementById("minimap-canvas");
      const mmCtx = mmCanvas.getContext("2d");
      const worldLabelEl = document.getElementById("world-label");
      const dirArrow = document.getElementById("dir-arrow");
      const dpr = window.devicePixelRatio || 1;

      let width = 0;
      let height = 0;
      let baseScale = 1;
      let viewScale = 1;

      // počáteční náklon kamery
      let rotX = -0.5;
      let rotY = 0.7;

      // světy v 3D
      const WORLD_HALF = 2.2;
      const worldCenters = [
        { x: -WORLD_HALF, z: 0 }, // levá krychle
        { x: WORLD_HALF, z: 0 }, // pravá krychle, navazuje stěnou
      ];
      let currentWorldIndex = 0;

      const heroPos = { x: worldCenters[0].x, y: 0, z: 0 };
      let activeHero = "vafit";

      const moveState = { up: false, down: false, left: false, right: false };
      const MOVE_SPEED = 2.5;
      let lastMoveAngle = 0; // pro směrový kurzor

      function resize() {
        const rect = canvas.getBoundingClientRect();
        width = rect.width;
        height = rect.height;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

        const mmRect = mmCanvas.getBoundingClientRect();
        mmCanvas.width = mmRect.width * dpr;
        mmCanvas.height = mmRect.height * dpr;
        mmCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

        baseScale = Math.min(width, height) * 0.18;
      }

      resize();
      window.addEventListener("resize", resize);

      // ----- 3D pomocné funkce -----
      function projectPoint(x, y, z) {
        // rotace kolem X
        let y1 = y * Math.cos(rotX) - z * Math.sin(rotX);
        let z1 = y * Math.sin(rotX) + z * Math.cos(rotX);
        // rotace kolem Y
        let x2 = x * Math.cos(rotY) + z1 * Math.sin(rotY);
        let z2 = -x * Math.sin(rotY) + z1 * Math.cos(rotY);

        const s = baseScale * viewScale;
        return {
          sx: x2 * s,
          sy: y1 * s,
          sz: z2,
        };
      }

      function clampHeroToWorld() {
        const c = worldCenters[currentWorldIndex];
        heroPos.x = Math.max(
          c.x - WORLD_HALF + 0.2,
          Math.min(c.x + WORLD_HALF - 0.2, heroPos.x)
        );
        heroPos.z = Math.max(
          -WORLD_HALF + 0.2,
          Math.min(WORLD_HALF - 0.2, heroPos.z)
        );
      }

      function checkPortal() {
        const c = worldCenters[currentWorldIndex];
        const threshold = WORLD_HALF - 0.25;

        if (currentWorldIndex === 0) {
          // pravá stěna levé krychle
          if (heroPos.x - c.x > threshold) {
            currentWorldIndex = 1;
            const c2 = worldCenters[1];
            heroPos.x = c2.x - WORLD_HALF + 0.3;
          }
        } else {
          // levá stěna pravé krychle
          if (heroPos.x - c.x < -threshold) {
            currentWorldIndex = 0;
            const c1 = worldCenters[0];
            heroPos.x = c1.x + WORLD_HALF - 0.3;
          }
        }
        worldLabelEl.textContent =
          currentWorldIndex === 0 ? "Kostka (Svět 1)" : "Kostka (Svět 2)";
      }

      // ----- KRESLENÍ KRYCHLÍ -----
      function drawCube(center, pulse) {
        const cubeY = WORLD_HALF + 0.4 + pulse * 0.5;

        const pts = [
          // spodní
          { x: center.x - WORLD_HALF, y: 0, z: -WORLD_HALF },
          { x: center.x + WORLD_HALF, y: 0, z: -WORLD_HALF },
          { x: center.x + WORLD_HALF, y: 0, z: WORLD_HALF },
          { x: center.x - WORLD_HALF, y: 0, z: WORLD_HALF },
          // horní
          { x: center.x - WORLD_HALF, y: cubeY * 2, z: -WORLD_HALF },
          { x: center.x + WORLD_HALF, y: cubeY * 2, z: -WORLD_HALF },
          { x: center.x + WORLD_HALF, y: cubeY * 2, z: WORLD_HALF },
          { x: center.x - WORLD_HALF, y: cubeY * 2, z: WORLD_HALF },
        ];

        const p = pts.map((pt) => projectPoint(pt.x, pt.y, pt.z));

        ctx.strokeStyle = "rgba(244,215,161,0.95)";
        ctx.lineWidth = 1.2;
        ctx.shadowColor = "rgba(244,215,161,0.9)";
        ctx.shadowBlur = 8;

        function line(a, b) {
          ctx.beginPath();
          ctx.moveTo(a.sx, a.sy);
          ctx.lineTo(b.sx, b.sy);
          ctx.stroke();
        }

        // spodní
        line(p[0], p[1]);
        line(p[1], p[2]);
        line(p[2], p[3]);
        line(p[3], p[0]);
        // horní
        line(p[4], p[5]);
        line(p[5], p[6]);
        line(p[6], p[7]);
        line(p[7], p[4]);
        // svislé
        line(p[0], p[4]);
        line(p[1], p[5]);
        line(p[2], p[6]);
        line(p[3], p[7]);

        ctx.shadowBlur = 0;
      }

      function drawWorlds(time) {
        ctx.clearRect(0, 0, width, height);

        ctx.save();
        ctx.translate(width / 2, height / 2 + 20);

        // Glow
        const gBg = ctx.createRadialGradient(
          0,
          -baseScale * 1.6,
          baseScale * 0.3,
          0,
          0,
          baseScale * 4
        );
        gBg.addColorStop(0, "rgba(255,210,150,0.08)");
        gBg.addColorStop(1, "rgba(0,0,0,0)");
        ctx.fillStyle = gBg;
        ctx.fillRect(-width, -height, width * 2, height * 2);

        // Stín
        ctx.beginPath();
        ctx.ellipse(
          0,
          baseScale * 1.3,
          baseScale * 2.3,
          baseScale * 0.8,
          0,
          0,
          Math.PI * 2
        );
        ctx.fillStyle = "rgba(0,0,0,0.8)";
        ctx.fill();

        const pulse = Math.sin(time * 1.6) * 0.05;

        // dvě krychle
        drawCube(worldCenters[0], pulse);
        drawCube(worldCenters[1], pulse * 0.7);

        // portál mezi krychlemi (střed stěn)
        const portalSize = 0.7;
        const c1 = worldCenters[0];
        const c2 = worldCenters[1];

        const portal1a = projectPoint(
          c1.x + WORLD_HALF,
          0.01,
          -portalSize
        );
        const portal1b = projectPoint(
          c1.x + WORLD_HALF,
          0.01,
          portalSize
        );
        const portal2a = projectPoint(
          c2.x - WORLD_HALF,
          0.01,
          -portalSize
        );
        const portal2b = projectPoint(
          c2.x - WORLD_HALF,
          0.01,
          portalSize
        );

        ctx.strokeStyle = "rgba(96,239,196,0.9)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(portal1a.sx, portal1a.sy);
        ctx.lineTo(portal1b.sx, portal1b.sy);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(portal2a.sx, portal2a.sy);
        ctx.lineTo(portal2b.sx, portal2b.sy);
        ctx.stroke();

        // HRDINA
        const heroProj = projectPoint(heroPos.x, 0, heroPos.z);
        ctx.save();
        ctx.translate(heroProj.sx, heroProj.sy - 5);

        const floatY = Math.sin(time * 3) * 4;

        if (activeHero === "vafit") {
          ctx.strokeStyle = "#7fffd4";
          ctx.lineWidth = 2;

          // tělo
          ctx.beginPath();
          ctx.moveTo(0, -12 + floatY);
          ctx.lineTo(0, -2 + floatY);
          ctx.lineTo(0, 8 + floatY);
          ctx.stroke();

          // nohy
          ctx.beginPath();
          ctx.moveTo(0, 8 + floatY);
          ctx.lineTo(-6, 16 + floatY);
          ctx.moveTo(0, 8 + floatY);
          ctx.lineTo(6, 16 + floatY);
          ctx.stroke();

          // ruce
          ctx.beginPath();
          ctx.moveTo(-7, 0 + floatY);
          ctx.lineTo(7, 0 + floatY);
          ctx.stroke();

          // hlava
          ctx.beginPath();
          ctx.arc(0, -18 + floatY, 6, 0, Math.PI * 2);
          ctx.stroke();
        } else {
          // Vivere mráček
          ctx.strokeStyle = "#a5fffe";
          ctx.lineWidth = 2;

          ctx.beginPath();
          const r = 9;
          for (let i = 0; i <= 24; i++) {
            const t = (i / 24) * Math.PI * 2;
            const rr = r + Math.sin(t * 3) * 1.8;
            const x = Math.cos(t) * rr;
            const y = Math.sin(t) * (rr * 0.55) - 4 + floatY;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }
          ctx.stroke();

          // ocásek
          ctx.beginPath();
          ctx.moveTo(0, 4 + floatY);
          ctx.lineTo(5, 10 + floatY);
          ctx.lineTo(-2, 16 + floatY);
          ctx.stroke();
        }

        ctx.restore();
        ctx.restore();
      }

      // ----- MINI MAPA -----
      function drawMinimap() {
        const w = mmCanvas.width / dpr;
        const h = mmCanvas.height / dpr;
        mmCtx.clearRect(0, 0, w, h);

        mmCtx.fillStyle = "#020617";
        mmCtx.fillRect(0, 0, w, h);

        const padding = 6;
        const worldWidth = (w - padding * 3) / 2;
        const worldHeight = h - padding * 2;

        mmCtx.strokeStyle = "#f4d7a1";
        mmCtx.lineWidth = 1;

        // levá krychle
        mmCtx.strokeRect(padding, padding, worldWidth, worldHeight);
        // pravá krychle
        mmCtx.strokeRect(
          padding * 2 + worldWidth,
          padding,
          worldWidth,
          worldHeight
        );

        let heroWorldX =
          currentWorldIndex === 0
            ? padding
            : padding * 2 + worldWidth;

        const c = worldCenters[currentWorldIndex];
        const tx =
          ((heroPos.x - c.x + WORLD_HALF) / (WORLD_HALF * 2)) *
          worldWidth;
        const tz =
          ((heroPos.z + WORLD_HALF) / (WORLD_HALF * 2)) *
          worldHeight;

        mmCtx.beginPath();
        mmCtx.arc(
          heroWorldX + tx,
          padding + worldHeight - tz,
          3,
          0,
          Math.PI * 2
        );
        mmCtx.fillStyle =
          activeHero === "vafit" ? "#7fffd4" : "#a5fffe";
        mmCtx.fill();
      }

      // ----- POHYB -----
      function setMove(key, isDown) {
        if (key === "ArrowUp" || key === "w") moveState.up = isDown;
        if (key === "ArrowDown" || key === "s") moveState.down = isDown;
        if (key === "ArrowLeft" || key === "a") moveState.left = isDown;
        if (key === "ArrowRight" || key === "d") moveState.right = isDown;
      }

      window.addEventListener("keydown", (e) => setMove(e.key, true));
      window.addEventListener("keyup", (e) => setMove(e.key, false));

      document.querySelectorAll(".btn-arrow").forEach((btn) => {
        const dir = btn.dataset.dir;
        if (!dir) return;

        const start = () => {
          if (dir === "up") moveState.up = true;
          if (dir === "down") moveState.down = true;
          if (dir === "left") moveState.left = true;
          if (dir === "right") moveState.right = true;
        };
        const stop = () => {
          if (dir === "up") moveState.up = false;
          if (dir === "down") moveState.down = false;
          if (dir === "left") moveState.left = false;
          if (dir === "right") moveState.right = false;
        };

        btn.addEventListener("mousedown", start);
        btn.addEventListener("touchstart", (e) => {
          e.preventDefault();
          start();
        });
        window.addEventListener("mouseup", stop);
        window.addEventListener("touchend", stop);
        window.addEventListener("touchcancel", stop);
      });

      function stepMovement(dt) {
        let dx = 0;
        let dz = 0;
        if (moveState.up) dz -= 1;
        if (moveState.down) dz += 1;
        if (moveState.left) dx -= 1;
        if (moveState.right) dx += 1;

        if (dx || dz) {
          const len = Math.hypot(dx, dz);
          dx /= len;
          dz /= len;

          heroPos.x += dx * MOVE_SPEED * dt;
          heroPos.z += dz * MOVE_SPEED * dt;

          // update směrového kurzoru (mapujeme z-axis na obrazovku)
          const sx = dx;
          const sy = -dz;
          lastMoveAngle = Math.atan2(sy, sx);
          dirArrow.style.opacity = "1";
          dirArrow.style.transform =
            "translate(-50%, -50%) rotate(" +
            lastMoveAngle +
            "rad)";

          clampHeroToWorld();
          checkPortal();
        } else {
          // lehké vyblednutí, ale ponecháme poslední směr
          dirArrow.style.opacity = "0.25";
        }
      }

      // ----- PŘEPÍNAČ HRDINŮ -----
      const btnVafit = document.getElementById("btn-vafit");
      const btnVivere = document.getElementById("btn-vivere");

      function setHero(hero) {
        activeHero = hero;
        btnVafit.classList.toggle("active", hero === "vafit");
        btnVivere.classList.toggle("active", hero === "vivere");
      }

      btnVafit.addEventListener("click", () => setHero("vafit"));
      btnVivere.addEventListener("click", () => setHero("vivere"));

      // ----- KAMERA: DRAG + PINCH / KOLEČKO -----
      let dragging = false;
      let lastX = 0;
      let lastY = 0;
      let pinchDist = 0;
      let pinchActive = false;

      canvas.addEventListener("mousedown", (e) => {
        dragging = true;
        lastX = e.clientX;
        lastY = e.clientY;
      });

      window.addEventListener("mouseup", () => {
        dragging = false;
        pinchActive = false;
      });

      window.addEventListener("mousemove", (e) => {
        if (!dragging || pinchActive) return;
        const dx = e.clientX - lastX;
        const dy = e.clientY - lastY;
        lastX = e.clientX;
        lastY = e.clientY;

        rotY += dx * 0.004;
        rotX += dy * 0.004;
        rotX = Math.max(-1.2, Math.min(0.2, rotX));
      });

      canvas.addEventListener(
        "touchstart",
        (e) => {
          if (e.touches.length === 1) {
            dragging = true;
            pinchActive = false;
            lastX = e.touches[0].clientX;
            lastY = e.touches[0].clientY;
          } else if (e.touches.length === 2) {
            dragging = false;
            pinchActive = true;
            const dx =
              e.touches[0].clientX - e.touches[1].clientX;
            const dy =
              e.touches[0].clientY - e.touches[1].clientY;
            pinchDist = Math.hypot(dx, dy);
          }
          e.preventDefault();
        },
        { passive: false }
      );

      window.addEventListener(
        "touchmove",
        (e) => {
          if (pinchActive && e.touches.length === 2) {
            const dx =
              e.touches[0].clientX - e.touches[1].clientX;
            const dy =
              e.touches[0].clientY - e.touches[1].clientY;
            const dist = Math.hypot(dx, dy);
            const factor = dist / pinchDist;
            pinchDist = dist;
            viewScale *= factor;
            viewScale = Math.max(0.7, Math.min(2.2, viewScale));
          } else if (dragging && e.touches.length === 1) {
            const t = e.touches[0];
            const dx = t.clientX - lastX;
            const dy = t.clientY - lastY;
            lastX = t.clientX;
            lastY = t.clientY;
            rotY += dx * 0.004;
            rotX += dy * 0.004;
            rotX = Math.max(-1.2, Math.min(0.2, rotX));
          }
          e.preventDefault();
        },
        { passive: false }
      );

      window.addEventListener(
        "touchend",
        () => {
          dragging = false;
          pinchActive = false;
        },
        { passive: false }
      );

      canvas.addEventListener("wheel", (e) => {
        e.preventDefault();
        const factor = e.deltaY > 0 ? 0.9 : 1.1;
        viewScale *= factor;
        viewScale = Math.max(0.7, Math.min(2.2, viewScale));
      });

      // ----- LOOP -----
      let lastTime = performance.now();

      function loop(now) {
        const dt = Math.min((now - lastTime) / 1000, 0.05);
        lastTime = now;

        // žádné auto-točení, kamera stojí – hýbeš jen ty
        stepMovement(dt);
        drawWorlds(now / 1000);
        drawMinimap();

        requestAnimationFrame(loop);
      }

      requestAnimationFrame(loop);
    </script>
  </body>
</html>
