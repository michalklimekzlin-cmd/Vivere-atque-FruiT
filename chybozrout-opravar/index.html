<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chybo≈ærout-Oprav√°≈ô v2.6 ‚Ä¢ Tiles + Drawer</title>
  <meta name="theme-color" content="#000000" />
  <style>
    :root{
      --bg:#000; --fg:#f5f5f5; --muted:#bdbdbd;
      --pane:#0c0c0c; --line:#1a1a1a; --ok:#86efac; --bad:#fca5a5; --warn:#facc15; --acc:#e84a4a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased}
    .wrap{max-width:1120px;margin:18px auto;padding:0 14px}

    .header{display:flex;gap:12px;align-items:baseline;margin-bottom:10px}
    .title{font-size:22px;font-weight:800}
    .sub{color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{background:var(--pane);border:1px solid var(--line);border-radius:14px;padding:14px}
    .kpi{font-size:30px;font-weight:800}
    .muted{color:var(--muted);font-size:12px}
    #scanLog{min-height:140px;white-space:pre-wrap;line-height:1.35;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}

    .list{max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:12px}
    .err{padding:10px 12px;border-bottom:1px solid var(--line)}
    .err:last-child{border-bottom:none}
    .msg{font-size:13px}
    .meta{color:var(--muted);font-size:11px;margin-top:4px}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }

    /* ======= Tiles (ƒçtvereƒçky) ======= */
    .tiles{display:grid;grid-template-columns:repeat(4,minmax(72px,1fr));gap:10px;margin-top:10px}
    @media (max-width:720px){ .tiles{grid-template-columns:repeat(2,minmax(120px,1fr))} }
    .tile{
      aspect-ratio:1 / 1;
      border:1px solid var(--line);
      border-radius:14px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;
      background:#0b0b0b; cursor:pointer; user-select:none;
      transition:transform .1s ease, background .2s ease, border-color .2s ease;
      text-align:center; padding:8px;
    }
    .tile:hover{ background:#111; border-color:#2a2a2a; }
    .tile:active{ transform:scale(0.98); }
    .tile b{font-size:20px}
    .tile span{font-size:12px;color:#ddd}

    /* ======= Drawer (v√Ωsuvn√Ω panel) ======= */
    .drawer{
      position:fixed; left:0; right:0; bottom:-420px;
      background:rgba(20,20,20,.98);
      border-top:1px solid var(--line);
      box-shadow:0 -30px 80px rgba(0,0,0,.5);
      transition:bottom .28s ease;
      z-index:50;
    }
    .drawer.open{ bottom:0; }
    .drawer .inner{max-width:1120px;margin:0 auto;padding:14px}
    .drawer .row{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .drawer .desc{font-size:14px;color:#ddd;line-height:1.45; padding:8px 0}
    .drawer button{
      background:#111;color:#fff;border:1px solid var(--line);
      padding:10px 14px;border-radius:12px;cursor:pointer;min-width:160px;
    }
    .drawer .primary{border-color:#2a2a2a;background:#151515}
    .drawer .close{opacity:.7}

    footer{margin:14px 0;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">üõ†Ô∏è Chybo≈ærout-Oprav√°≈ô <span id="ver">v2.6</span></div>
      <div class="sub">‚ÄûV√≠ce hlav = m√©nƒõ p√°d≈Ø‚Äú</div>
    </div>

    <div class="grid">
      <!-- KPI + Tiles -->
      <div class="card">
        <div class="row" style="display:flex;justify-content:space-between;gap:12px">
          <div>
            <div class="muted">√örove≈à</div>
            <div class="kpi" id="lvl">1</div>
          </div>
          <div>
            <div class="muted">Chyby ve frontƒõ</div>
            <div class="kpi" id="qcnt">0</div>
          </div>
        </div>

        <!-- ƒåTVERCE / Tiles -->
        <div class="tiles" id="tiles">
          <div class="tile" data-action="attach"><b>üß†</b><span>Zachyt√°vat chyby</span></div>
          <div class="tile" data-action="scan"><b>üîé</b><span>Sken index≈Ø</span></div>
          <div class="tile" data-action="deps"><b>üì¶</b><span>Sken z√°vislost√≠</span></div>
          <div class="tile" data-action="fallback"><b>üßØ</b><span>Opravit (fallback)</span></div>

          <div class="tile" data-action="fix1"><b>üîß</b><span>Opravit nejbli≈æ≈°√≠</span></div>
          <div class="tile" data-action="fixall"><b>‚ú®</b><span>Opravit v≈°e</span></div>
          <div class="tile" data-action="sim"><b>üí•</b><span>Simulovat chybu</span></div>
          <div class="tile" data-action="export"><b>üì§</b><span>Export report</span></div>
        </div>
      </div>

      <!-- Log -->
      <div class="card">
        <div class="muted">Syst√©mov√Ω log</div>
        <div id="scanLog">Inicializace syst√©mu‚Ä¶</div>
      </div>
    </div>

    <!-- Fronta chyb -->
    <div class="card" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="muted">Fronta chyb / chybƒõj√≠c√≠ch soubor≈Ø</div>
        <button id="btn-clear" style="background:#111;color:#fff;border:1px solid var(--line);padding:8px 12px;border-radius:10px;cursor:pointer">üßπ Vyƒçistit log</button>
      </div>
      <div id="errList" class="list"></div>
    </div>

    <footer>Souƒç√°st svƒõta Vivere atque FruiT ‚Ä¢ build v2.6 (tiles + drawer)</footer>
  </div>

  <!-- V√Ωsuvn√Ω panel -->
  <div class="drawer" id="drawer">
    <div class="inner">
      <div class="row">
        <div id="drawer-title" style="font-weight:700">Akce</div>
        <div>
          <button class="close" id="drawer-close">Zav≈ô√≠t</button>
          <button class="primary" id="drawer-run">Spustit</button>
        </div>
      </div>
      <div id="drawer-desc" class="desc">Popis akce‚Ä¶</div>
    </div>
  </div>

  <script>
  /* ===========================
     üß† RepairNet v2.6 (core)
     ‚Äì vych√°z√≠ z v2.5
  ============================ */
  (function(){
    const VERSION = 'v2.6';
    const MAX_QUEUE = 400;
    const ROOTS = [
      '../Revia/',
      '../Braska-Hlava/',
      '../Hlavoun/',
      '../Meziprostor-Core/',
      '../VAFT-Network/'
    ];
    const FALLBACK_BASE = location.origin + location.pathname.replace(/\/[^/]*$/,'/') + '../fallback/';

    const state = {
      queue: [],
      fixed: parseInt(localStorage.getItem('vaft.chzr.fixed')||'0',10),
      lvl:   parseInt(localStorage.getItem('vaft.chzr.lvl')||'1',10),
      scanning:false,
      handlers:false
    };
    const save = ()=>{ localStorage.setItem('vaft.chzr.fixed', state.fixed); localStorage.setItem('vaft.chzr.lvl', state.lvl); };

    function enqueue(obj){
      const item = {
        t: Date.now(),
        type: obj?.type || 'error',
        msg: (obj && (obj.message||obj.msg||obj)) + '',
        src: obj?.src || '',
        line: obj?.line || '',
        col: obj?.col || '',
        stack: obj?.stack ? String(obj.stack).slice(0,1500) : ''
      };
      state.queue.push(item);
      if (state.queue.length > MAX_QUEUE) state.queue.shift();
      return item;
    }
    function fixNext(){
      if (!state.queue.length) return null;
      const it = state.queue.shift();
      state.fixed++; if (state.fixed % 3 === 0) state.lvl++; save();
      return it;
    }
    function fixAll(){ let n=state.queue.length; while(state.queue.length) fixNext(); return n; }

    async function check(url){
      try{ const r = await fetch(url, {cache:'no-store'}); return {ok:r.ok, status:r.status}; }
      catch(e){ return {ok:false, status:e.message}; }
    }
    async function fetchText(url){
      const r = await fetch(url, {cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status); return await r.text();
    }
    const RES_RE = /<(script|img|link|audio|video)\b[^>]+?(?:src|href)\s*=\s*["']([^"']+)["'][^>]*>/gi;
    const toAbs = (base, rel)=> /^https?:\/\//i.test(rel) ? rel : new URL(rel, base).href;

    async function scanIndexAndDeps(root, logFn){
      const indexUrl = new URL(root+'index.html','https://michalklimekzlin-cmd.github.io/Vivere-atque-FruiT/').href;
      logFn && logFn('üîé Index: '+indexUrl);
      let html='';
      try{ html = await fetchText(indexUrl); logFn && logFn('‚úÖ '+indexUrl+' (OK)'); }
      catch(e){ enqueue({type:'missing-index', msg:'Index nedostupn√Ω', src:indexUrl, stack:e.message}); logFn && logFn('‚ùå '+indexUrl+' ('+e.message+')'); return; }

      const base = indexUrl; const found = new Set(); let m;
      while((m = RES_RE.exec(html)) !== null){ const rel = m[2]; if(/manifest\.json$/i.test(rel)) continue; found.add(toAbs(base, rel)); }
      for (const u of found){
        const r = await check(u);
        if (!r.ok){ enqueue({type:'missing-asset', msg:'Chyb√≠ asset', src:u, stack:'status: '+r.status}); logFn && logFn('‚ùå '+u+' ('+r.status+')'); }
        else { logFn && logFn('‚úÖ '+u+' ('+r.status+')'); }
      }
    }
    async function scanDeep(logFn){
      state.scanning = true;
      for (const r of ROOTS){ await scanIndexAndDeps(r, logFn); }
      state.scanning = false;
    }

    async function tryRepairMissing(logFn){
      const missing = state.queue.filter(x=>x.type==='missing-asset');
      if(!missing.length){ logFn && logFn('‚ú® Nen√≠ co opravovat (missing-asset).'); return 0; }
      let repaired = 0;
      for (const m of missing){
        try{
          const url = new URL(m.src);
          const relPath = url.pathname.replace(/^\/+/, '').replace(/^Vivere-atque-FruiT\//,'');
          const fbUrl = new URL(relPath, FALLBACK_BASE).href;
          const chk = await check(fbUrl);
          if (!chk.ok){ logFn && logFn('‚ö†Ô∏è Fallback nenalezen: '+fbUrl); continue; }

          if (/\.(js)(\?|$)/i.test(fbUrl)){
            await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=fbUrl; s.onload=res; s.onerror=rej; document.body.appendChild(s); });
            repaired++; logFn && logFn('üîß Nahr√°n fallback skript: '+fbUrl);
          } else if (/\.(css)(\?|$)/i.test(fbUrl)){
            const l=document.createElement('link'); l.rel='stylesheet'; l.href=fbUrl; document.head.appendChild(l);
            repaired++; logFn && logFn('üîß Nahr√°n fallback styl: '+fbUrl);
          } else { repaired++; logFn && logFn('üîß Fallback dostupn√Ω: '+fbUrl); }

          const idx = state.queue.indexOf(m);
          if (idx>=0){ state.queue.splice(idx,1); state.fixed++; if(state.fixed%3===0) state.lvl++; save(); }
        }catch(e){ logFn && logFn('‚ùå Oprava selhala: '+(e.message||e)); }
      }
      return repaired;
    }

    function attachHandlers(){
      if (state.handlers) return false;
      state.handlers = true;
      const origError = console.error;
      console.error = function(...args){ try{ enqueue({ msg: args.join(' ') }); }catch(e){} return origError.apply(console,args); };
      window.onerror = (msg, src, line, col, error)=>{ enqueue({ msg, src, line, col, stack:error && error.stack }); return false; };
      window.addEventListener('unhandledrejection', (e)=>{ const r=e.reason||{}; enqueue({ msg:'PromiseRejection: '+(r.message||r), stack:r.stack }); });
      return true;
    }

    window.RepairNet = {
      version: VERSION,
      getQueue: ()=> state.queue.slice(),
      getFixedCount: ()=> state.fixed,
      getLevel: ()=> state.lvl,
      isScanning: ()=> state.scanning,
      feedError: enqueue,
      fixNext, fixAll,
      scanDeep, scanIndexAndDeps,
      tryRepairMissing,
      attachHandlers
    };
  })();

  /* ===========================
     üñ•Ô∏è UI ‚Äì Tiles + Drawer
  ============================ */
  (function(){
    const $ = (q)=>document.querySelector(q);
    const elVer=$('#ver'), elLvl=$('#lvl'), elQ=$('#qcnt'), elLog=$('#scanLog'), elList=$('#errList');
    const tiles=$('#tiles');
    const drawer=$('#drawer'), dTitle=$('#drawer-title'), dDesc=$('#drawer-desc'), dRun=$('#drawer-run'), dClose=$('#drawer-close');
    const bClear=$('#btn-clear');

    const safe = (s)=> (''+s).replace(/[<&>]/g, c=>({ '<':'&lt;','>':'&gt;','&':'&amp;' }[c]));
    function logLine(txt){ const line=document.createElement('div'); line.textContent=`[${new Date().toLocaleTimeString()}] ${txt}`; elLog.appendChild(line); elLog.scrollTop=elLog.scrollHeight; }
    function renderKPI(){ elVer.textContent='v'+(window.RepairNet?.version||'?'); elLvl.textContent=window.RepairNet.getLevel(); elQ.textContent=window.RepairNet.getQueue().length; }
    function renderList(){
      const q = window.RepairNet.getQueue().slice().reverse();
      elList.innerHTML = q.map(x=>{
        const t=new Date(x.t).toLocaleString();
        const meta=[x.type, x.src, x.line&&('≈ô:'+x.line), x.col&&('sl:'+x.col)].filter(Boolean).join(' ‚Ä¢ ');
        const stack=x.stack?`<div class="meta">${safe(x.stack)}</div>`:'';
        return `<div class="err"><div class="msg ${x.type==='missing-asset'?'warn':'bad'}">${safe(x.msg||'Chyba')}</div><div class="meta">${safe(t)} ‚Ä¢ ${safe(meta)}</div>${stack}</div>`;
      }).join('') || `<div class="err"><div class="msg ok">≈Ω√°dn√© polo≈æky ve frontƒõ.</div></div>`;
    }

    // Drawer ovl√°d√°n√≠
    let pendingAction = null;
    function openDrawer(title, desc, run){
      dTitle.textContent = title;
      dDesc.textContent = desc;
      pendingAction = run;
      drawer.classList.add('open');
    }
    dClose.addEventListener('click', ()=> drawer.classList.remove('open'));
    dRun.addEventListener('click', async ()=>{
      if (!pendingAction) return;
      dRun.disabled = true;
      try{ await pendingAction(); }
      finally{ dRun.disabled=false; drawer.classList.remove('open'); renderKPI(); renderList(); }
    });

    // Akce map
    const actions = {
      attach(){
        openDrawer('Zachyt√°vat chyby',
          'Zapne handlery (window.onerror, unhandledrejection, console.error), aby Chybo≈ærout sb√≠ral ud√°losti t√©to aplikace.',
          async ()=>{ const ok = window.RepairNet.attachHandlers(); logLine(ok?'üß† Zachyt√°v√°n√≠ zapnuto.':'‚ÑπÔ∏è U≈æ bƒõ≈æ√≠.'); }
        );
      },
      scan(){
        openDrawer('Sken index≈Ø',
          'Zkontroluje index.html ve v≈°ech z√°kladn√≠ch modulech (Revia, Hlavoun, Meziprostor‚Ä¶)',
          async ()=>{ logLine('üîé Spou≈°t√≠m sken index≈Ø‚Ä¶'); await window.RepairNet.scanDeep(m=>logLine(m)); logLine('‚úÖ Sken index≈Ø hotov.'); }
        );
      },
      deps(){
        openDrawer('Sken z√°vislost√≠',
          'Naƒçte indexy, vyparsuje JS/CSS/IMG/AUDIO/VIDEO a otestuje jejich dostupnost.',
          async ()=>{
            logLine('üì¶ Sken z√°vislost√≠ (v≈°echny moduly)‚Ä¶');
            const roots=['../Revia/','../Braska-Hlava/','../Hlavoun/','../Meziprostor-Core/','../VAFT-Network/'];
            for (const r of roots){ await window.RepairNet.scanIndexAndDeps(r, m=>logLine(m)); }
            logLine('‚úÖ Sken z√°vislost√≠ dokonƒçen.');
          }
        );
      },
      fallback(){
        openDrawer('Oprava p≈ôes fallback',
          'Pokus√≠ se automaticky nahr√°t chybƒõj√≠c√≠ soubory ze slo≈æky /fallback/ (pokud existuj√≠).',
          async ()=>{ const n = await window.RepairNet.tryRepairMissing(m=>logLine(m)); logLine(n?`‚ú® Opraveno p≈ôes fallback: ${n}`:'‚ÑπÔ∏è Nic k opravƒõ / fallback nedostupn√Ω.'); }
        );
      },
      fix1(){
        openDrawer('Opravit nejbli≈æ≈°√≠',
          'Odstran√≠ prvn√≠ polo≈æku z fronty a zv√Ω≈°√≠ postup/√∫rove≈à oprav√°≈ôe.',
          async ()=>{ const it=window.RepairNet.fixNext(); logLine(it?('üîß Opraveno: '+(it.msg||'nezn√°m√°')):'‚ú® Nen√≠ co opravovat.'); }
        );
      },
      fixall(){
        openDrawer('Opravit v≈°e',
          'Vyƒçist√≠ frontu v≈°ech chyb a chybƒõj√≠c√≠ch asset≈Ø (jako ‚Äûhmotn√° oprava‚Äú).',
          async ()=>{ const n=window.RepairNet.fixAll(); logLine(n?`‚ú® Opraveno v≈°e: ${n} polo≈æek.`:'‚ú® Fronta pr√°zdn√°.'); }
        );
      },
      sim(){
        openDrawer('Nasimulovat chybu',
          'Vlo≈æ√≠ do konzole a Promisu testovac√≠ chyby, aby bylo co opravovat.',
          async ()=>{ console.error('SimulatedError: test z UI'); Promise.reject(new Error('AsyncFail: Promise test')); logLine('üí• Chyby nasimulov√°ny.'); }
        );
      },
      export(){
        openDrawer('Export reportu',
          'Vygeneruje JSON s frontou chyb a poƒçitadly (√∫rove≈à, opravy).',
          async ()=>{
            const report = {
              generatedAt: new Date().toISOString(),
              version: window.RepairNet.version,
              level: window.RepairNet.getLevel(),
              fixed: window.RepairNet.getFixedCount(),
              queue: window.RepairNet.getQueue()
            };
            const blob = new Blob([JSON.stringify(report,null,2)], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'vaft-repair-report.json';
            document.body.appendChild(a); a.click(); a.remove();
            logLine('üì§ Export hotov: vaft-repair-report.json');
          }
        );
      }
    };

    // Kliky na tiles
    tiles.addEventListener('click', (e)=>{
      const t = e.target.closest('.tile');
      if (!t) return;
      const act = t.dataset.action;
      if (actions[act]) actions[act]();
    });

    // Vyƒçistit log panel (ne frontu)
    bClear.addEventListener('click', ()=>{ elLog.textContent=''; logLine('üßπ Log vyƒçi≈°tƒõn.'); });

    // Boot
    logLine('‚úÖ UI p≈ôipraveno ‚Ä¢ kompatibiln√≠ s RepairNet v'+(window.RepairNet?.version||'?'));
    (function renderLoop(){ renderKPI(); renderList(); setTimeout(renderLoop, 1000); })();
  })();
  </script>
</body>
</html>
