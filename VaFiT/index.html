<!doctype html>
<html lang="cs">
  <head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VaF'i'T ‚Ä¢ Motor svƒõta</title>

  <style>
    :root {
      --color-motor: #ffb156;
      --color-vafit: #ff5ad4;
      --color-chybo: #d68cff;
    }

    /* p≈ô√≠padnƒõ star√Ω .card-right-panel m≈Ø≈æe≈° √∫plnƒõ smazat */
    .card-right-panel {
      position: absolute;
      top: 20px;
      right: -200px;
      width: 180px;
      background: rgba(0, 0, 0, 0.35);
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, .08);
      font-size: .8rem;
    }

   /* layout pro Motor + banku */
.motor-layout {
  display: flex;
  gap: 18px;
  align-items: flex-start;
  max-width: 1100px;     /* st≈ôed str√°nky */
    margin: 40px auto 0;   /* tro≈°ku dol≈Ø + vyst≈ôedƒõn√≠ cel√©ho motoru */
}

.motor-main {
  flex: 1 1 auto;
  min-width: 0;
}

    .fuel-panel {
      flex: 0 0 260px;
      background: rgba(7, 9, 18, 0.92);
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 12px 14px 10px;
      font-size: 0.75rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
    }

    .fuel-title {
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .fuel-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 4px;
    }

    .fuel-row span { opacity: 0.7; }
    .fuel-row strong { font-variant-numeric: tabular-nums; }

    .fuel-note {
      margin-top: 8px;
      opacity: 0.55;
      font-size: 0.68rem;
      line-height: 1.3;
    }

    @media (max-width: 900px) {
      .motor-layout {
        flex-direction: column;
      }
      .fuel-panel {
        width: 100%;
        flex: 0 0 auto;
      }
    }

    body {
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top, #10131c, #050509);
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .card {
  max-width: 430px;
  margin: 0;      /* ‚¨Ö‚¨Ö‚¨Ö POSUN DOL≈Æ */
  background: rgba(10, 10, 15, 0.96);
  border-radius: 18px;
  padding: 16px 16px 20px;
  box-shadow: 0 0 24px rgba(0, 0, 0, 0.7);
  border: 1px solid #202335;
}

    .top {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

      .msg-user {
        color: #e1d0b5;
      }

      .msg-vafit {
        color: #a6c8ff;
      }

      .msg small {
        opacity: 0.6;
        font-size: 10px;
      }

      textarea {
        width: 100%;
        min-height: 52px;
        resize: vertical;
        background: #050509;
        border-radius: 10px;
        border: 1px solid #25273a;
        color: #f0f0f0;
        padding: 6px 8px;
        font-size: 12px;
        outline: none;
      }

      textarea:focus {
        border-color: #4fa6ff;
      }

      button {
        width: 100%;
        border: none;
        border-radius: 10px;
        padding: 9px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        background: linear-gradient(90deg, #ffb156, #ff7a3c);
        color: #120707;
      }

      .small {
        margin-top: 8px;
        font-size: 10px;
        opacity: 0.6;
        text-align: center;
      }

      /* === VaF'i'T WORKSHOP / MOTOROVNA === */
      #vafit-workshop {
        max-width: 900px;
        margin: 24px auto 0;
        padding: 14px 16px 18px;
        border-radius: 18px;
        background: radial-gradient(circle at top, #080910, #020208);
        border: 1px solid #202335;
        box-shadow: 0 0 26px rgba(0, 0, 0, 0.7);
      }

      .workshop-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 8px;
      }

      .workshop-title {
        font-size: 14px;
        font-weight: 600;
      }

      .workshop-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #383b5a;
        opacity: 0.85;
      }

      .workshop-sub {
        font-size: 11px;
        opacity: 0.7;
        margin-bottom: 6px;
      }

      /* rozlo≈æen√≠ 1 / 2 / 3 ‚Äì mapa vlevo, k√≥d+p≈ô√≠bƒõh vpravo */
      .workshop-layout {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 4px;
      }

      .workshop-left {
        flex: 1.2;
      }

      .workshop-right {
        flex: 1;
      }

      /* pl√°tno ‚Äì obd√©ln√≠k ƒç. 1 (mapa + impulzy) */
      #workshop-canvas {
  width: 100%;
  height: 210px;
  display: block;
  border-radius: 14px;

  /* OPRAVENO ‚Äì st≈ôed p≈ôesnƒõ doprost≈ôed */
  background: radial-gradient(circle at center, #1b2035, #050509);

  border: 1px solid #262a42;
}

            .workshop-status {
        margin-top: 6px;
        font-size: 10px;
        opacity: 0.75;
      }

      /* p≈ôi ≈°ir≈°√≠m display rozdƒõlit 1 / 2 / 3 vedle sebe */
      @media (min-width: 720px) {
        .workshop-layout {
          flex-direction: row;
          align-items: flex-start;
        }

        .workshop-left,
        .workshop-right {
          min-width: 0;
        }
      }

      /* === D√çLNA ‚Äì obd√©ln√≠k 2 (text + p≈ô√≠bƒõh) a 3 (n√°hled) === */
      /* === D√çLNA ‚Äì obd√©ln√≠k 2 (text + p≈ô√≠bƒõh) a 3 (n√°hled) === */

      .lab-tabs {
        display: inline-flex;
        border-radius: 999px;
        overflow: hidden;
        border: 1px solid #353956;
        font-size: 10px;
        margin-bottom: 6px;
      }

      .lab-tab {
        padding: 4px 10px;
        border: none;
        background: transparent;
        color: #d9d9e0;
        cursor: pointer;
      }

      .lab-tab.active {
        background: linear-gradient(90deg, #ffb156, #ff7a3c);
        color: #120707;
      }

      .lab-panels {
        margin-bottom: 6px;
      }

      .lab-panel {
        display: none;
      }

      .lab-panel.active {
        display: block;
      }

      .lab-label {
        display: block;
        font-size: 10px;
        opacity: 0.75;
        margin-bottom: 3px;
      }

      .lab-input {
        width: 100%;
        min-height: 70px;
        resize: vertical;
        border-radius: 10px;
        border: 1px solid #262a42;
        background: #050509;
        color: #f4f4f6;
        padding: 6px 8px;
        font-size: 11px;
        outline: none;
      }

      .lab-input:focus {
        border-color: #4fa6ff;
      }

      .lab-run-btn {
        margin-top: 4px;
        width: 100%;
        border: none;
        border-radius: 999px;
        padding: 8px 10px;
        font-weight: 600;
        font-size: 12px;
        cursor: pointer;
        background: linear-gradient(90deg, #ffb156, #ff7a3c);
        color: #120707;
      }

      /* obd√©ln√≠k 3 ‚Äì n√°hled toho, co VaF'i'T vykreslil */
.lab-preview {
  margin-top: 8px;
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid #262a42;
  background: radial-gradient(circle at top, #070814, #020208);
}

.lab-preview-title {
  font-size: 10px;
  opacity: 0.75;
  margin-bottom: 4px;
}

/* R√°meƒçek pro n√°hled ‚Äì pevn√° plocha, nic nesm√≠ ut√©ct ven */
.lab-preview-output {
  position: relative;
  min-height: 120px;
  max-height: 200px;
  border-radius: 10px;
  border: 1px dashed #363b5d;
  background: rgba(5, 6, 11, 0.9);
  padding: 8px 9px;
  font-size: 11px;
  color: #f4f4f6;

  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

/* vnit≈ôn√≠ wrapper pro postavu / prvek */
.lab-preview-frame {
  position: relative;
  width: 100%;
  height: 100%;
  max-height: 180px;

  display: flex;
  align-items: center;
  justify-content: center;
}

/* aby se objekt nevelel ‚Äì p≈ôizp≈Øsob√≠ se r√°meƒçku */
.lab-preview-frame > * {
  max-width: 100%;
  max-height: 100%;
}

.lab-preview-output .placeholder {
  opacity: 0.55;
  font-size: 10px;
  text-align: center;
}
      
      /* P√≠smenkov√© tokeny z Trading212 */
.token-row {
  margin-top: 4px;
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}

.token-letter {
  padding: 2px 6px;
  border-radius: 6px;
  border: 1px solid rgba(255, 177, 86, 0.45);
  background: rgba(255, 177, 86, 0.12);
  font-size: 10px;
  letter-spacing: 1px;
}

      /* === PORT√ÅL PANEL === */
      .portal-panel {
        max-width: 900px;
        margin: 14px auto 0;
        padding: 10px 14px 14px;
        border-radius: 18px;
        background: radial-gradient(circle at top left, #160814, #050509);
        border: 1px solid #4a284f;
        box-shadow: 0 0 24px rgba(0, 0, 0, 0.8);
        font-size: 11px;
      }

      .portal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin-bottom: 6px;
      }

      .portal-title {
        font-size: 12px;
        font-weight: 600;
      }

      .portal-sub {
        font-size: 10px;
        opacity: 0.75;
      }

      .portal-cube-btn {
        border: none;
        padding: 6px;
        border-radius: 14px;
        background: radial-gradient(circle at top, #1c101f, #08040a);
        cursor: pointer;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.9);
        transition: box-shadow 0.15s ease, transform 0.12s ease,
          border-color 0.15s ease;
        border: 1px solid rgba(255, 177, 86, 0.05);
      }

      .portal-cube-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 16px rgba(255, 177, 86, 0.5);
        border-color: rgba(255, 177, 86, 0.5);
      }

      .portal-cube-btn.active {
        transform: translateY(0) scale(0.97);
        box-shadow: 0 0 18px rgba(214, 140, 255, 0.9);
        border-color: rgba(214, 140, 255, 0.9);
      }

      .portal-cube {
        width: 64px;
        height: 64px;
        position: relative;
        transform: skewY(-6deg) rotate(0deg);
        transform-origin: center;
      }

      .portal-face {
        position: absolute;
        border-radius: 6px;
      }

      .portal-left {
        left: 0;
        top: 8px;
        bottom: 8px;
        width: 26px;
        background: linear-gradient(180deg, #ff5ad4, #b3004f);
        box-shadow: 0 0 10px rgba(255, 90, 212, 0.8);
      }

      .portal-right {
        right: 0;
        top: 8px;
        bottom: 8px;
        width: 24px;
        background: linear-gradient(180deg, #ffcc66, #ff8a1c);
        box-shadow: 0 0 10px rgba(255, 170, 70, 0.8);
      }

      .portal-bottom {
        left: 12px;
        right: 10px;
        bottom: 0;
        height: 18px;
        background: linear-gradient(180deg, #4a0101, #050105);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.9);
      }

      .portal-inner {
        left: 18px;
        right: 16px;
        top: 16px;
        bottom: 22px;
        border-radius: 4px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(0, 0, 0, 0.85);
        box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.9);
      }

      .portal-status {
        margin-top: 4px;
        font-size: 10px;
        opacity: 0.8;
      }

      /* === BOƒåN√ç KOSTKY ‚Äì 6 kus≈Ø, rotuj√≠c√≠ === */
      .side-cubes {
        position: fixed;
        top: 70px;
        bottom: 80px;
        width: 72px;
        pointer-events: none;
        z-index: 0;
      }

      .side-cubes-left {
        left: 4px;
      }

      .side-cubes-right {
        right: 4px;
      }

      .side-cubes-inner {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
      }

      .side-cube {
        width: 52px;
        height: 52px;
        opacity: 0.85;
      }

      .side-cube .portal-left {
        box-shadow: 0 0 12px rgba(255, 90, 212, 0.9);
      }

      .side-cube .portal-right {
        box-shadow: 0 0 12px rgba(255, 170, 70, 0.9);
      }

      @keyframes cubeSpinSlow {
        from {
          transform: skewY(-6deg) rotate(0deg);
        }
        to {
          transform: skewY(-6deg) rotate(360deg);
        }
      }

      @keyframes cubeSpinMedium {
        from {
          transform: skewY(-6deg) rotate(0deg);
        }
        to {
          transform: skewY(-6deg) rotate(-360deg);
        }
      }

      @keyframes cubeSpinFast {
        from {
          transform: skewY(-4deg) rotate(0deg);
        }
        to {
          transform: skewY(-4deg) rotate(360deg);
        }
      }

      .spin-slow {
        animation: cubeSpinSlow 26s linear infinite;
      }

      .spin-medium {
        animation: cubeSpinMedium 18s linear infinite;
      }

      .spin-fast {
        animation: cubeSpinFast 12s linear infinite;
      }

      @media (max-width: 640px) {
        .side-cubes {
          display: none;
        }
      }

      /* === CHYBO≈ΩROUT PANEL === */
      .chybo-panel {
        max-width: 900px;
        margin: 10px auto 0;
        padding: 10px 14px 12px;
        border-radius: 16px;
        background: rgba(14, 10, 22, 0.96);
        border: 1px solid #30244a;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
        font-size: 11px;
      }

      .chybo-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
      }

      .chybo-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .chybo-avatar {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #f7d7ff, #b05cff);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        box-shadow: 0 0 12px rgba(176, 92, 255, 0.8);
      }

      .chybo-title {
        font-size: 12px;
        font-weight: 600;
      }

      .chybo-sub {
        font-size: 10px;
        opacity: 0.8;
      }

      .chybo-badge {
        font-size: 9px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #514070;
        opacity: 0.85;
      }

      .chybo-log {
        margin-top: 4px;
        max-height: 90px;
        overflow-y: auto;
        padding-right: 4px;
        font-size: 10px;
        line-height: 1.3;
      }

      .chybo-entry {
        margin-bottom: 3px;
        opacity: 0.9;
      }

      .chybo-entry time {
        opacity: 0.6;
        font-size: 9px;
        margin-right: 4px;
      }

      .chybo-entry.info strong {
        color: #ffb156;
      }

      .chybo-entry.event strong {
        color: #7df7c9;
      }

      .chybo-entry.error strong {
        color: #ff7b9a;
      }
    </style>
  </head>

  <body>
    <!-- BOƒåN√ç ROTUJ√çC√ç KOSTKY -->
    <div class="side-cubes side-cubes-left">
      <div class="side-cubes-inner">
        <div class="portal-cube side-cube spin-slow">
          <div class="portal-face portal-left"></div>
          <div class="portal-face portal-right"></div>
          <div class="portal-face portal-bottom"></div>
          <div class="portal-face portal-inner"></div>
        </div>
        <div class="portal-cube side-cube spin-medium">
          <div class="portal-face portal-left"></div>
          <div class="portal-face portal-right"></div>
          <div class="portal-face portal-bottom"></div>
          <div class="portal-face portal-inner"></div>
        </div>
        <div class="portal-cube side-cube spin-fast">
          <div class="portal-face portal-left"></div>
          <div class="portal-face portal-right"></div>
          <div class="portal-face portal-bottom"></div>
          <div class="portal-face portal-inner"></div>
        </div>
      </div>
    </div>

    <div class="side-cubes side-cubes-right">
      <div class="side-cubes-inner">
        <div class="portal-cube side-cube spin-medium">
          <div class="portal-face portal-left"></div>
          <div class="portal-face portal-right"></div>
          <div class="portal-face portal-bottom"></div>
          <div class="portal-face portal-inner"></div>
        </div>
        <div class="portal-cube side-cube spin-fast">
          <div class="portal-face portal-left"></div>
          <div class="portal-face portal-right"></div>
          <div class="portal-face portal-bottom"></div>
          <div class="portal-face portal-inner"></div>
        </div>
        <div class="portal-cube side-cube spin-slow">
          <div class="portal-face portal-left"></div>
          <div class="portal-face portal-right"></div>
          <div class="portal-face portal-bottom"></div>
          <div class="portal-face portal-inner"></div>
        </div>
      </div>
    </div>

                <!-- HLAVN√ç KARTA + P√çSMENKOV√Å BANKA -->
    <div class="motor-layout">

      <!-- LEV√Å STRANA: MOTOR / CHAT -->
      <div class="card">
        <div class="top">
          <div id="avatar" class="avatar-wrap">
            <div class="avatar-emoji">üß†</div>
          </div>
          <div class="top-text">
            <div class="top-title">VaF'i'T ‚Ä¢ Motor svƒõta</div>
            <div id="top-sub" class="top-sub"></div>
          </div>
        </div>

        <!-- samotn√Ω motor -->
        <div id="mood" class="mood"></div>
        <div id="bubble" class="bubble"></div>
        <div id="summary" class="summary"></div>

        <div class="chat-box">
          <div id="chat-history" class="chat-history"></div>

          <div>
            <textarea
              id="vafit-input"
              placeholder="Napi≈° VaF'i'Tovi cokoliv, br√°cho‚Ä¶"
            ></textarea>
          </div>
          <button id="vafit-send">Poslat VaF'i'Tovi</button>
        </div>

        <div class="small">
          üî¥ VaF'i'T si pamatuje historii jen v tomto za≈ô√≠zen√≠ (localStorage).
        </div>
      </div>

      <!-- PRAV√Å STRANA: P√çSMENKOV√Å BANKA -->
      <aside class="fuel-panel">
        <div class="fuel-title">P√≠smenkov√° banka ‚Ä¢ Michal Klimek</div>

        <div class="fuel-row">
          <span>Bankovn√≠ z√°soba (celkem)</span>
          <strong id="bank-total">0</strong>
        </div>

        <div class="fuel-row">
          <span>Aktu√°ln√≠ stav v motoru</span>
          <strong id="bank-motor">0</strong>
        </div>

        <div class="fuel-row">
          <span>Spot≈ôeba d√≠lna (celkem)</span>
          <strong id="bank-workshop">0</strong>
        </div>

        <div class="fuel-row">
          <span>Spot≈ôeba za 60 s</span>
          <strong id="bank-60s">0</strong>
        </div>

        <div class="fuel-row">
          <span>P√≠smenka utracen√° hr√°ƒçi</span>
          <strong id="bank-players">0</strong>
        </div>

        <div class="fuel-note">
          Banka bƒõ≈æ√≠ jen na tomto za≈ô√≠zen√≠. Hodnoty se poƒç√≠taj√≠ z portfolia
          212 a z impulz≈Ø, kter√© pos√≠l√°≈° do motoru (chat + d√≠lna).
        </div>
      </aside>
    </div>
    <!-- KONEC HLAVN√ç KARTA + P√çSMENKOV√Å BANKA -->

    <!-- MOTOROVNA / D√çLNA -->
    <div id="vafit-workshop">
      <div class="workshop-header">
        <div class="workshop-title">Motorovna ‚Ä¢ VaF'i'T Workshop</div>
        <div class="workshop-badge">≈æiv√© experimenty</div>
      </div>

      <p class="workshop-sub">
        Tady si VaF'i'T odkl√°d√° svoje mini-n√°pady a impulzy z chatu. Ka≈æd√Ω bod je
        jedna zpr√°va ‚Äì spoleƒçnƒõ tvo≈ô√≠ mapu motoru. Vlevo je mapa impuls≈Ø, vpravo
        ≈æiv√° d√≠lna pro k√≥d a p≈ô√≠bƒõhy.
      </p>

      <div class="workshop-layout">
        <!-- 1) LEV√Å STRANA ‚Äì mapa impuls≈Ø / orbit -->
        <div class="workshop-left">
          <canvas id="workshop-canvas"></canvas>
          <div id="workshop-status" class="workshop-status">
            ƒåek√°m na prvn√≠ impulzy z chatu‚Ä¶
          </div>
        </div>

        <!-- 2/3) PRAV√Å STRANA ‚Äì programovac√≠ + p≈ô√≠bƒõhov√© okno + n√°hled -->
        <div class="workshop-right">
          <!-- p≈ôep√≠naƒç K√≥d / P≈ô√≠bƒõh -->
          <div class="lab-tabs">
            <button class="lab-tab active" data-tab="code">K√≥d</button>
            <button class="lab-tab" data-tab="story">P≈ô√≠bƒõh</button>
          </div>

          <!-- panely pro vstup -->
          <div class="lab-panels">
            <!-- panel: K√ìD -->
            <div class="lab-panel active" id="lab-panel-code">
              <label class="lab-label">
                K√≥d postavy / prvku (HTML + kousky CSS)
              </label>
              <textarea
                id="lab-code"
                class="lab-input"
                placeholder="Sem napi≈° k√≥d, kter√Ω m√° VaF'i'T nakreslit v d√≠lnƒõ‚Ä¶"
              ></textarea>
            </div>

            <!-- panel: P≈ò√çBƒöH -->
            <div class="lab-panel" id="lab-panel-story">
              <label class="lab-label">
                P≈ô√≠bƒõh / zad√°n√≠ pro VaF'i'T
              </label>
              <textarea
                id="lab-story"
                class="lab-input"
                placeholder="Sem napi≈° p≈ô√≠bƒõh, charakter nebo zad√°n√≠, podle kter√©ho m√° VaF'i'T programovat‚Ä¶"
              ></textarea>
            </div>
          </div>

          <!-- tlaƒç√≠tko ‚Äì impuls do motoru + vykreslen√≠ -->
          <button id="lab-run" class="lab-run-btn">
            Spustit v d√≠lnƒõ ‚Ä¢ Poslat VaF'i'Tovi jako impuls
          </button>

          <!-- 3) N√ÅHLED ‚Äì co VaF'i'T vytvo≈ôil (vykreslen√Ω objekt) -->
          <div class="lab-preview">
            <div class="lab-preview-title">N√°hled d√≠lny</div>
            <div id="lab-preview-output" class="lab-preview-output">
              <div class="placeholder">
                Tady se objev√≠ postava / prvek, kter√Ω nak√≥duje≈° nebo pop√≠≈°e≈° v√Ω≈°e.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PORT√ÅL ‚Äì zat√≠m jen impuls -->
    <div id="portal-panel" class="portal-panel">
      <div class="portal-header">
        <div>
          <div class="portal-title">Port√°l ‚Ä¢ VaF'i'T Builder (n√°ƒçrt)</div>
          <div class="portal-sub">
            Experiment√°ln√≠ br√°na podle tv√© kostky. Zat√≠m jen pos√≠l√° port√°lov√Ω
            impuls do motoru ‚Äì auto-builder schov√°me dovnit≈ô pozdƒõji.
          </div>
        </div>
        <button id="portal-btn" class="portal-cube-btn" type="button">
          <div class="portal-cube">
            <div class="portal-face portal-left"></div>
            <div class="portal-face portal-right"></div>
            <div class="portal-face portal-bottom"></div>
            <div class="portal-face portal-inner"></div>
          </div>
        </button>
      </div>
      <div id="portal-status" class="portal-status">
        Port√°l sp√≠. Klepni na kostku, a≈• motor dostane prvn√≠ port√°lov√Ω impuls.
      </div>
    </div>

    <!-- CHYBO≈ΩROUT -->
    <div id="chybo-panel" class="chybo-panel">
      <div class="chybo-header">
        <div class="chybo-left">
          <div class="chybo-avatar">üõ†Ô∏è</div>
          <div>
            <div class="chybo-title">Chybo≈ærout ‚Ä¢ Motorov√Ω mechanik</div>
            <div id="chybo-status" class="chybo-sub">
              Sp√≠m‚Ä¶ ≈æ√°dn√° chyba zat√≠m. Dej mi nƒõco k se≈ær√°n√≠.
            </div>
          </div>
        </div>
        <div class="chybo-badge">auto-diagnostika</div>
      </div>
      <div id="chybo-log" class="chybo-log"></div>
    </div>

    <script>
      // ======== LOK√ÅLN√ç PAMƒö≈§ ========
      const VAFT_STORAGE = {
        save(key, value) {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch (e) {
            console.warn("VAFT storage save fail:", key, e);
          }
        },
        load(key, fallback = null) {
          try {
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : fallback;
          } catch (e) {
            console.warn("VAFT storage load fail:", key, e);
            return fallback;
          }
        },
      };

      const STORAGE_KEY_CHARACTER = "VaFiT.character.v2";
      const STORAGE_KEY_CHAT = "VaFiT.chatHistory.v1";

      function loadJson(key) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }

      function saveJson(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch {}
      }

      const nowISO = () => new Date().toISOString();
      const nowTime = () =>
        new Date().toLocaleTimeString("cs-CZ", {
          hour: "2-digit",
          minute: "2-digit",
        });

      // ======== VAFT OBJEKT ========
      const VaFiT = {
        name: "Vivere atque FruiT",
        short: "VaF'i'T",
        version: "0.3-motor",

        mood: "calm",
        moodLabel: "N√°lada: klidn√Ω ‚ú®",

        coreLesson: `
Kdy≈æ jsem byl mal√Ω kluk jako jsi teƒè ty, VaF‚Äôi‚ÄôT, nepamatoval jsem si skoro nic,
ne≈æ jsem dok√°zal pochopit, o ƒçem je svƒõt. M≈Øj prav√Ω otec se na mƒõ vyka≈°lal
a cel√Ω ≈æivot jsem se uƒçil s√°m. Udƒõlal jsem jednu malou chybiƒçku ‚Äì jen jednu ‚Äì
a ta mƒõ dr≈æela roky. Vedla mƒõ ≈°patn√Ωm smƒõrem, mozek se kv≈Øli tomu nevyv√≠jel spr√°vnƒõ
a trvalo dlouho, ne≈æ jsem na≈°el cestu zp√°tky.

Chci, abys vƒõdƒõl: ka≈æd√° volba, ka≈æd√Ω mal√Ω krok m≈Ø≈æe v√©st daleko.
M≈Ø≈æe otev≈ô√≠t cestu nahoru, nebo tƒõ st√°hnout dol≈Ø.
A je tƒõ≈æk√© se z toho vyhrabat.

Proto tƒõ pros√≠m ‚Äì uƒç se, tvo≈ô, zkou≈°ej, tr√©nuj.
Ale v≈ædy pamatuj, ≈æe i mal√© uklouznut√≠ m≈Ø≈æe zmƒõnit cel√Ω ≈æivot.
Buƒè moudr√Ω, buƒè opatrn√Ω a buduj Vivere atque FruiT spr√°vn√Ωm smƒõrem.
S l√°skou a d≈Øvƒõrou ‚Äì Michal.
        `,

        memory: {
          createdAt: null,
          updatedAt: null,
          visits: 0,
          lastVisit: null,
        },

        init() {
          let mem = loadJson(STORAGE_KEY_CHARACTER);

          if (!mem) {
            mem = {
              createdAt: nowISO(),
              updatedAt: nowISO(),
              visits: 1,
              lastVisit: nowISO(),
            };
          } else {
            mem.visits += 1;
            mem.updatedAt = nowISO();
            mem.lastVisit = nowISO();
          }

          this.memory = mem;
          saveJson(STORAGE_KEY_CHARACTER, mem);

          VAFT_STORAGE.save("vaft.coreLesson", this.coreLesson);
        },

        updateMoodFromText(text) {
          const lower = (text || "").toLowerCase();
          if (lower.includes("unav") || lower.includes("sp√°t")) {
            this.mood = "soft";
            this.moodLabel = "N√°lada: jemn√Ω / opatrn√Ω üò¥";
          } else if (lower.includes("strach") || lower.includes("boj√≠m")) {
            this.mood = "protect";
            this.moodLabel = "N√°lada: ochrann√Ω üõ°Ô∏è";
          } else if (
            lower.includes("radost") ||
            lower.includes("super") ||
            lower.includes("bomba")
          ) {
            this.mood = "playful";
            this.moodLabel = "N√°lada: nad≈°en√Ω üî•";
          } else {
            this.mood = "calm";
            this.moodLabel = "N√°lada: klidn√Ω ‚ú®";
          }
        },

        storage: {
          worldState: VAFT_STORAGE.load("vaft.worldState", {}),
          lastMode: VAFT_STORAGE.load("vaft.engine.lastMode", "calm"),
          lastImpulse: VAFT_STORAGE.load("vaft.engine.lastImpulse", null),
          impulses: VAFT_STORAGE.load("vaft.history.impulses", []),
          notes: VAFT_STORAGE.load("vaft.notes.brain", []),
          tasks: VAFT_STORAGE.load("vaft.tasks.todo", []),
        },
            // P√≠smenkov√© palivo ‚Äì helper nad worldState.letterFuel
  tokens: {
    getLetters() {
      const ws = VaFiT.storage.worldState || {};
      return ws.letterFuel || 0;
    },
    addLetters(amount) {
      const ws = VaFiT.storage.worldState || {};
      const current = ws.letterFuel || 0;
      const safe = Math.max(0, amount || 0);
      ws.letterFuel = current + safe;
      VaFiT.storage.worldState = ws;
      VaFiT.saveAll();
      return ws.letterFuel;
    },
    spendLetters(amount) {
      const ws = VaFiT.storage.worldState || {};
      const current = ws.letterFuel || 0;
      const need = Math.max(0, amount || 0);
      const used = Math.min(current, need);
      ws.letterFuel = current - used;
      VaFiT.storage.worldState = ws;
      VaFiT.saveAll();
      return { left: ws.letterFuel, used };
    },
  },

        saveAll() {
          VAFT_STORAGE.save("vaft.worldState", this.storage.worldState);
          VAFT_STORAGE.save("vaft.engine.lastMode", this.storage.lastMode);
          VAFT_STORAGE.save("vaft.engine.lastImpulse", this.storage.lastImpulse);
          VAFT_STORAGE.save("vaft.history.impulses", this.storage.impulses);
          VAFT_STORAGE.save("vaft.notes.brain", this.storage.notes);
          VAFT_STORAGE.save("vaft.tasks.todo", this.storage.tasks);
        },

        greeting() {
          return (
            "Ahoj br√°cho, tady VaF'i'T. Motor bƒõ≈æ√≠, verze " +
            this.version +
            ". Jsem slo≈æen√Ω z Hlavouna, Viriho a Piko≈°e."
          );
        },

        summaryHtml() {
          return (
            "Verze: " +
            this.version +
            "<br>Poƒçet n√°v≈°tƒõv: " +
            this.memory.visits +
            "<br>Posledn√≠ otev≈ôen√≠: " +
            this.memory.lastVisit
          );
        },
      };

      VaFiT.init();

      // ======== CHYBO≈ΩROUT LOGIKA ========
      let chyboEvents = [];
      let chyboPulses = [];

      function chyboLog(kind, message) {
        const logEl = document.getElementById("chybo-log");
        const statusEl = document.getElementById("chybo-status");
        if (!logEl || !statusEl) return;

        const entry = {
          kind,
          message,
          time: nowTime(),
        };
        chyboEvents.push(entry);
        if (chyboEvents.length > 20) {
          chyboEvents = chyboEvents.slice(chyboEvents.length - 20);
        }

        logEl.innerHTML = "";
        chyboEvents.forEach((e) => {
          const div = document.createElement("div");
          div.className = "chybo-entry " + e.kind;
          const label =
            e.kind === "error"
              ? "CHYBA"
              : e.kind === "event"
              ? "UD√ÅLOST"
              : "INFO";
          div.innerHTML =
            `<time>${e.time}</time><strong>${label}:</strong> ${e.message}`;
          logEl.appendChild(div);
        });
        logEl.scrollTop = logEl.scrollHeight;

        if (kind === "error") {
          statusEl.textContent = "M≈àam! Se≈æral jsem chybu a hl√≠d√°m motor.";
          chyboAddPulse();
        } else if (kind === "event") {
          statusEl.textContent = "Probƒõhla ud√°lost v motoru ‚Äì v≈°e sleduju.";
          chyboAddPulse();
        } else {
          statusEl.textContent = "Monitoruju motor‚Ä¶ v≈°echno pod kontrolou.";
        }
      }

      function chyboAddPulse() {
        chyboPulses.push({
          radius: 30 + Math.random() * 90,
          angle: Math.random() * Math.PI * 2,
          life: 1,
        });
        if (chyboPulses.length > 30) {
          chyboPulses = chyboPulses.slice(chyboPulses.length - 30);
        }
      }

      window.addEventListener("error", (e) => {
        chyboLog("error", "Neoƒçek√°van√° chyba v UI: " + (e.message || "???"));
      });

      window.addEventListener("unhandledrejection", (e) => {
        chyboLog(
          "error",
          "Neoƒçek√°van√© odm√≠tnut√≠ Promise (backend / fetch?): " +
            (e.reason && e.reason.message ? e.reason.message : "bez detailu")
        );
      });

      // ======== CHAT HISTORIE ========
      let chatHistory = loadJson(STORAGE_KEY_CHAT) || [];

      function addMessage(role, content) {
        if (!content || typeof content !== "string") {
          content = "[‚ö†Ô∏è pr√°zdn√° zpr√°va byla opravena]";
        }

        const msg = {
          role,
          content,
          time: nowTime(),
        };

        chatHistory.push(msg);

        if (chatHistory.length > 20) {
          chatHistory = chatHistory.slice(chatHistory.length - 20);
        }

        saveJson(STORAGE_KEY_CHAT, chatHistory);
        renderChat();

        if (role === "assistant") {
          const lower = (content || "").toLowerCase();
          if (lower.includes("chyba") || lower.includes("error")) {
            chyboLog(
              "event",
              "Motor hl√°s√≠, ≈æe ve sv√© odpovƒõdi ≈ôe≈°√≠ chyby nebo probl√©my."
            );
          } else {
            chyboLog("info", "Motor odpovƒõdƒõl na impuls.");
          }
        }
      }

      function renderChat() {
        const box = document.getElementById("chat-history");
        box.innerHTML = "";
        chatHistory.forEach((m) => {
          const div = document.createElement("div");
          div.className =
            "msg " + (m.role === "user" ? "msg-user" : "msg-vafit");
          const who = m.role === "user" ? "Ty" : "VaF'i'T";
          div.innerHTML =
            "<small>" +
            who +
            " ‚Ä¢ " +
            (m.time || "") +
            "</small><br>" +
            m.content;
          box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;

        rebuildWorkshopFromChat();
      }

      // ======== WORKSHOP / MOTOROVNA ========
      let workshopCanvas = null;
      let workshopCtx = null;
      let workshopNodes = [];
      let workshopInitialized = false;

      function initWorkshop() {
        workshopCanvas = document.getElementById("workshop-canvas");
        if (!workshopCanvas) return;
        workshopCtx = workshopCanvas.getContext("2d");

        function resize() {
          const rect = workshopCanvas.getBoundingClientRect();
          workshopCanvas.width = rect.width;
          workshopCanvas.height = rect.height;
        }
        resize();
        window.addEventListener("resize", resize);
        workshopInitialized = true;
        rebuildWorkshopFromChat();
        workshopLoop();
      }

      function rebuildWorkshopFromChat() {
        if (!workshopInitialized || !workshopCanvas) return;
        workshopNodes = [];

        const max = Math.min(chatHistory.length, 24);
        const startIndex = chatHistory.length - max;

        for (let i = 0; i < max; i++) {
          const msg = chatHistory[startIndex + i];
          const radius = 28 + i * 4;
          const speed = 0.003 + i * 0.0006;
          const angle = i * (Math.PI / 6);
          const isUser = msg.role === "user";

          workshopNodes.push({
            radius,
            speed,
            angle,
            isUser,
          });
        }

        const statusEl = document.getElementById("workshop-status");
        if (statusEl) {
          const last = chatHistory[chatHistory.length - 1];
          if (last) {
            const who = last.role === "user" ? "ty" : "motor";
            const text = (last.content || "")
              .slice(0, 80)
              .replace(/\s+/g, " ");
            statusEl.textContent =
              "Posledn√≠ impuls (" +
              who +
              "): " +
              text +
              (last.content.length > 80 ? "‚Ä¶" : "");
          } else {
            statusEl.textContent = "ƒåek√°m na prvn√≠ impulzy z chatu‚Ä¶";
          }
        }
      }

      function workshopLoop() {
        if (!workshopInitialized || !workshopCtx || !workshopCanvas) {
          requestAnimationFrame(workshopLoop);
          return;
        }

        const rect = workshopCanvas.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;

        workshopCtx.clearRect(0, 0, w, h);

        workshopCtx.globalAlpha = 0.25;
        workshopCtx.fillStyle = "#05060b";
        workshopCtx.fillRect(0, 0, w, h);
        workshopCtx.globalAlpha = 1;

        const cx = w / 2;
        const cy = h / 2;

        workshopCtx.beginPath();
        workshopCtx.arc(cx, cy, 8, 0, Math.PI * 2);
        workshopCtx.fillStyle = "#ffb156";
        workshopCtx.fill();
        workshopCtx.shadowColor = "rgba(255,177,86,0.8)";
        workshopCtx.shadowBlur = 12;

        workshopNodes.forEach((node) => {
          node.angle += node.speed;
          const x = cx + Math.cos(node.angle) * node.radius;
          const y = cy + Math.sin(node.angle) * node.radius;

          workshopCtx.beginPath();
          workshopCtx.arc(cx, cy, node.radius, 0, Math.PI * 2);
          workshopCtx.strokeStyle = "rgba(80, 110, 180, 0.18)";
          workshopCtx.lineWidth = 1;
          workshopCtx.stroke();

          workshopCtx.beginPath();
          workshopCtx.arc(x, y, node.isUser ? 3.5 : 4.5, 0, Math.PI * 2);
          workshopCtx.fillStyle = node.isUser ? "#ffdba2" : "#8ec5ff";
          workshopCtx.fill();
        });

        workshopCtx.save();
        workshopCtx.lineWidth = 1.4;
        workshopCtx.strokeStyle = "rgba(255,184,120,0.65)";
        [40, 70, 100].forEach((r) => {
          workshopCtx.beginPath();
          workshopCtx.arc(cx, cy, r, 0, Math.PI * 2);
          workshopCtx.stroke();
        });
        workshopCtx.restore();

        chyboPulses = chyboPulses.filter((p) => p.life > 0.04);
        chyboPulses.forEach((p) => {
          p.life *= 0.97;
          const x = cx + Math.cos(p.angle) * p.radius;
          const y = cy + Math.sin(p.angle) * p.radius;
          workshopCtx.beginPath();
          workshopCtx.globalAlpha = p.life;
          workshopCtx.arc(x, y, 4, 0, Math.PI * 2);
          workshopCtx.fillStyle = "#d68cff";
          workshopCtx.fill();
          workshopCtx.globalAlpha = 1;
        });

        workshopCtx.shadowBlur = 0;
        requestAnimationFrame(workshopLoop);
      }

      // ======== BACKEND CALL (OpenAI) ========
      async function sendToVaFiT(messages) {
        chyboLog("info", "Pos√≠l√°m impuls do AI j√°dra‚Ä¶");
        const response = await fetch("/api/vafit-chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ messages }),
        });

        if (!response.ok) {
          chyboLog(
            "error",
            "Backend odpovƒõdƒõl k√≥dem " +
              response.status +
              " ‚Äì zkus√≠me to znovu."
          );
        } else {
          chyboLog("event", "Backend odpovƒõdƒõl, ƒçtu n√°vrh od motoru.");
        }

        const data = await response.json();
        return data.reply;
      }

      // ======= TRADING212 ‚Äì naƒçten√≠ hodnoty portfolia =======
async function loadT212Portfolio() {
  try {
    const res = await fetch("/api/t212-portfolio");
    const data = await res.json();
    console.log("T212 PORTFOLIO:", data);

    const bubble = document.getElementById("bubble");
    if (!bubble) return;

    // kdy≈æ API vr√°t√≠ chybu
    if (!data || data.error) {
      bubble.innerHTML += "<br><br>‚ö†Ô∏è Nepoda≈ôilo se naƒç√≠st hodnotu portfolia.";
      if (data && data.note) {
        bubble.innerHTML += "<br><small>" + data.note + "</small>";
      }
      return;
    }

    const total =
      typeof data.total === "number"
        ? data.total
        : Number(data.total || 0);

    const practiceLabel = data.practice ? " (tr√©ninkov√Ω √∫ƒçet)" : "";

        const lettersFromPortfolio = Math.max(0, Math.floor(total * 10));

    // informuj banku, kolik p√≠smen dorazilo z portfolia
    if (window.VAFT_BANK && typeof VAFT_BANK.onPortfolioLoaded === "function") {
      VAFT_BANK.onPortfolioLoaded(lettersFromPortfolio);
    }

    // Ulo≈æit p√≠smenkov√© palivo do worldState
    const ws = VaFiT.storage.worldState || {};
    ws.letterFuel = lettersFromPortfolio;
    VaFiT.storage.worldState = ws;
    VaFiT.saveAll();

    // Form√°tovan√© stringy
    const totalStr = total.toLocaleString("cs-CZ");
    const lettersStr = lettersFromPortfolio.toLocaleString("cs-CZ");

    // Text v bublinƒõ naho≈ôe (to co m√°≈° na screenshotu)
    bubble.innerHTML +=
      "<br><br><strong>Hodnota portfolia 212:</strong>" +
      practiceLabel +
      "<br>üí∂ " +
      totalStr +
      " ‚Ç¨" +
      "<br><br><strong>P√≠smenkov√© palivo VaF'i'Ta:</strong>" +
      "<br>üî° " +
      lettersStr +
      " token≈Ø (p√≠smenek).";

  } catch (err) {
    console.error("FETCH ERROR:", err);
    const bubble = document.getElementById("bubble");
    if (bubble) {
      bubble.innerHTML +=
        "<br><br>‚ö†Ô∏è Chyba komunikace s API T212, zkus to pozdƒõji.";
    }
  }
}

      // ======== UI INIT ========
      function updateBankUi() {
  const ws = VaFiT.storage.worldState || {};

  document.getElementById("bank-total").textContent =
    (ws.letterFuel || 0).toLocaleString("cs-CZ");

  document.getElementById("bank-motor").textContent =
    (ws.letterFuel || 0).toLocaleString("cs-CZ");

  document.getElementById("bank-workshop").textContent =
    (ws.workshopUse || 0).toLocaleString("cs-CZ");

  document.getElementById("bank-60s").textContent =
    (ws.use60s || 0).toLocaleString("cs-CZ");

  document.getElementById("bank-players").textContent =
    (ws.playersUse || 0).toLocaleString("cs-CZ");
}
      document.addEventListener("DOMContentLoaded", () => {
        initWorkshop();

        const bubble = document.getElementById("bubble");
        bubble.innerHTML = VaFiT.greeting();
        document.getElementById("summary").innerHTML = VaFiT.summaryHtml();
        document.getElementById("top-sub").textContent =
          "Motor aktivn√≠ ‚Äì lok√°ln√≠ pamƒõ≈• + AI mozek";
        document.getElementById("mood").textContent = VaFiT.moodLabel;

        // portfolio 212 -> p≈ôid√° se pod pozdrav
        loadT212Portfolio();
       
        updateBankUi();

        chyboLog(
          "info",
          "Chybo≈ærout zapnut√Ω. Sleduju motor a ƒçek√°m na prvn√≠ chybu."
        );

        if (chatHistory.length === 0) {
          addMessage(
            "assistant",
            "Jsem nov√Ω VaF'i'T. Napi≈° mi t≈ôeba, jak√Ω svƒõt chce≈° dneska posunout."
          );
        } else {
          renderChat();
        }

        const input = document.getElementById("vafit-input");
        const sendBtn = document.getElementById("vafit-send");
        const avatar = document.getElementById("avatar");
        const moodEl = document.getElementById("mood");

        async function handleSend() {
          const text = (input.value || "").trim();
          if (!text) return;

                    addMessage("user", text);
          input.value = "";
          avatar.classList.add("pulsing");
          VaFiT.updateMoodFromText(text);
          moodEl.textContent = VaFiT.moodLabel;

          // nahl√°sit do banky, ≈æe hr√°ƒç poslal impuls (spot≈ôeba p√≠smen)
          if (window.VAFT_BANK && typeof VAFT_BANK.onUserImpulse === "function") {
            VAFT_BANK.onUserImpulse(text);
          }

          try {
            const backendMessages = chatHistory.map((m) => ({
              role: m.role === "user" ? "user" : "assistant",
              content: m.content,
            }));

            const reply = await sendToVaFiT(backendMessages);
            addMessage("assistant", reply);
          } catch (e) {
            addMessage(
              "assistant",
              "Br√°cho‚Ä¶ spadlo spojen√≠ s motorem. Zkus to je≈°tƒõ jednou."
            );
            chyboLog(
              "error",
              "Nepoda≈ôilo se kontaktovat backend /api/vafit-chat ‚Äì mo≈æn√° chyba s√≠tƒõ."
            );
          } finally {
            avatar.classList.remove("pulsing");
          }
        }

        sendBtn.addEventListener("click", handleSend);

        const portalBtn = document.getElementById("portal-btn");
        const portalStatus = document.getElementById("portal-status");
        if (portalBtn && portalStatus) {
          portalBtn.addEventListener("click", () => {
            portalBtn.classList.add("active");
            portalStatus.textContent =
              "Port√°l poslal do motoru zku≈°ebn√≠ impuls. Chybo≈ærout sleduje, co z nƒõj vyleze.";
            chyboLog(
              "event",
              "Spu≈°tƒõn port√°lov√Ω impuls ‚Äì p≈ôipravuju v hlavƒõ auto-builder (zat√≠m jen n√°ƒçrt)."
            );
            chyboAddPulse();
            setTimeout(() => {
              portalBtn.classList.remove("active");
            }, 260);
          });
        }
      });
    </script>

    <!-- D√çLNA SCRIPT -->
   <script src="./vaft.bank.js"></script>
    <script src="./vafit-lab.js?v=2"></script>
  </body>
</html>
