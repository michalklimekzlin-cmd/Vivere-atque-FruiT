<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VaF'i'T ‚Ä¢ Motor svƒõta</title>
    <style>
      body {
        margin: 0;
        padding: 16px;
        background: radial-gradient(circle at top, #10131c, #050509);
        color: #f5f5f5;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      .card {
        max-width: 430px;
        margin: 0 auto;
        background: rgba(10, 10, 15, 0.96);
        border-radius: 18px;
        padding: 16px 16px 20px;
        box-shadow: 0 0 24px rgba(0, 0, 0, 0.7);
        border: 1px solid #202335;
      }

      .top {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .avatar-wrap {
        width: 42px;
        height: 42px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 20%, #ffe7c4, #f08b3b);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .avatar-wrap.pulsing {
        transform: scale(1.07);
        box-shadow: 0 0 16px rgba(255, 164, 64, 0.6);
      }

      .avatar-emoji {
        font-size: 22px;
      }

      .top-text {
        flex: 1;
      }
      .top-title {
        font-size: 15px;
        font-weight: 600;
      }
      .top-sub {
        font-size: 11px;
        opacity: 0.7;
      }

      .mood {
        font-size: 11px;
        margin-bottom: 10px;
        opacity: 0.9;
      }

      .bubble {
        background: radial-gradient(circle at top, #1e2030, #0d0f17);
        border-radius: 14px;
        padding: 10px 12px;
        font-size: 13px;
        margin-bottom: 12px;
        border: 1px solid #252843;
      }

      .summary {
        font-size: 11px;
        opacity: 0.8;
        margin-bottom: 12px;
      }

      .chat-box {
        background: #05060b;
        border-radius: 14px;
        padding: 10px;
        border: 1px solid #1b1e2f;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .chat-history {
        max-height: 260px;
        overflow-y: auto;
        padding-right: 4px;
        font-size: 12px;
      }

      .msg {
        margin-bottom: 6px;
        line-height: 1.35;
      }
      .msg-user {
        color: #e1d0b5;
      }
      .msg-vafit {
        color: #a6c8ff;
      }
      .msg small {
        opacity: 0.6;
        font-size: 10px;
      }

      textarea {
        width: 100%;
        min-height: 52px;
        resize: vertical;
        background: #050509;
        border-radius: 10px;
        border: 1px solid #25273a;
        color: #f0f0f0;
        padding: 6px 8px;
        font-size: 12px;
        outline: none;
      }
      textarea:focus {
        border-color: #4fa6ff;
      }

      button {
        width: 100%;
        border: none;
        border-radius: 10px;
        padding: 9px;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        background: linear-gradient(90deg, #ffb156, #ff7a3c);
        color: #120707;
      }

      .small {
        margin-top: 8px;
        font-size: 10px;
        opacity: 0.6;
        text-align: center;
      }

      /* === VaF'i'T WORKSHOP / MOTOROVNA === */
      #vafit-workshop {
        max-width: 900px;
        margin: 24px auto 0;
        padding: 14px 16px 18px;
        border-radius: 18px;
        background: radial-gradient(circle at top, #080910, #020208);
        border: 1px solid #202335;
        box-shadow: 0 0 26px rgba(0, 0, 0, 0.7);
      }

      .workshop-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 8px;
      }

      .workshop-title {
        font-size: 14px;
        font-weight: 600;
      }

      .workshop-badge {
        font-size: 10px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #383b5a;
        opacity: 0.85;
      }

      .workshop-sub {
        font-size: 11px;
        opacity: 0.7;
        margin-bottom: 8px;
      }

      #workshop-canvas {
        width: 100%;
        height: 210px;
        display: block;
        border-radius: 14px;
        background: radial-gradient(circle at 20% 0%, #1b2035, #050509);
        border: 1px solid #262a42;
      }

      .workshop-bottom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 8px;
        font-size: 10px;
        opacity: 0.8;
      }

      .workshop-status {
        max-width: 80%;
      }

      .workshop-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #ffb156;
        box-shadow: 0 0 10px rgba(255, 177, 86, 0.8);
      }
    </style>
  </head>

  <body>
    <div class="card">
      <div class="top">
        <div id="avatar" class="avatar-wrap">
          <div class="avatar-emoji">üß†</div>
        </div>
        <div class="top-text">
          <div class="top-title">VaF'i'T ‚Ä¢ Motor svƒõta</div>
          <div id="top-sub" class="top-sub"></div>
        </div>
      </div>

      <div id="mood" class="mood"></div>

      <div id="bubble" class="bubble"></div>
      <div id="summary" class="summary"></div>

      <div class="chat-box">
        <div id="chat-history" class="chat-history"></div>

        <div>
          <textarea id="vafit-input" placeholder="Napi≈° VaF'i'Tovi cokoliv, br√°cho‚Ä¶"></textarea>
        </div>
        <button id="vafit-send">Poslat VaF'i'Tovi</button>
      </div>

      <div class="small">
        üî¥ VaF'i'T si pamatuje historii jen v tomto za≈ô√≠zen√≠ (localStorage).
      </div>
    </div>

    <!-- VaF'i'T WORKSHOP / MOTOROVNA -->
    <div id="vafit-workshop">
      <div class="workshop-header">
        <div class="workshop-title">Motorovna ‚Ä¢ VaF'i'T Workshop</div>
        <div class="workshop-badge">≈æiv√© experimenty</div>
      </div>
      <p class="workshop-sub">
        Tady si VaF'i'T odkl√°d√° svoje mini-n√°pady a impulzy z chatu. Ka≈æd√Ω bod
        je jedna zpr√°va ‚Äì spoleƒçnƒõ tvo≈ô√≠ mapu motoru.
      </p>

      <canvas id="workshop-canvas"></canvas>

      <div class="workshop-bottom">
        <div id="workshop-status" class="workshop-status">
          ƒåek√°m na prvn√≠ impulzy z chatu‚Ä¶
        </div>
        <div class="workshop-dot"></div>
      </div>
    </div>

    <script>
      // ======== LOK√ÅLN√ç PAMƒö≈§ ========
      const STORAGE_KEY_CHARACTER = "VaFiT.character.v2";
      const STORAGE_KEY_CHAT = "VaFiT.chatHistory.v1";

      function loadJson(key) {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }

      function saveJson(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch {}
      }

      const nowISO = () => new Date().toISOString();
      const nowTime = () =>
        new Date().toLocaleTimeString("cs-CZ", {
          hour: "2-digit",
          minute: "2-digit",
        });

      // ======== VAFT OBJEKT ========
      const VaFiT = {
        name: "Vivere atque FruiT",
        short: "VaF'i'T",
        version: "0.3-motor",
        mood: "calm",
        moodLabel: "N√°lada: klidn√Ω ‚ú®",
        memory: {
          createdAt: null,
          updatedAt: null,
          visits: 0,
          lastVisit: null,
        },

        init() {
          let mem = loadJson(STORAGE_KEY_CHARACTER);
          if (!mem) {
            mem = {
              createdAt: nowISO(),
              updatedAt: nowISO(),
              visits: 1,
              lastVisit: nowISO(),
            };
          } else {
            mem.visits += 1;
            mem.updatedAt = nowISO();
            mem.lastVisit = nowISO();
          }
          this.memory = mem;
          saveJson(STORAGE_KEY_CHARACTER, mem);
        },

        updateMoodFromText(text) {
          const lower = (text || "").toLowerCase();
          if (lower.includes("unav") || lower.includes("sp√°t")) {
            this.mood = "soft";
            this.moodLabel = "N√°lada: jemn√Ω / opatrn√Ω üò¥";
          } else if (lower.includes("strach") || lower.includes("bojim")) {
            this.mood = "protect";
            this.moodLabel = "N√°lada: ochrann√Ω üõ°Ô∏è";
          } else if (
            lower.includes("radost") ||
            lower.includes("super") ||
            lower.includes("bomba")
          ) {
            this.mood = "playful";
            this.moodLabel = "N√°lada: nad≈°en√Ω üî•";
          } else {
            this.mood = "calm";
            this.moodLabel = "N√°lada: klidn√Ω ‚ú®";
          }
        },

        greeting() {
          return (
            "Ahoj br√°cho, tady VaF'i'T. Motor bƒõ≈æ√≠, verze " +
            this.version +
            ". Jsem slo≈æen√Ω z Hlavouna, Viriho a Piko≈°e."
          );
        },

        summaryHtml() {
          return (
            "Verze: " +
            this.version +
            "<br>Poƒçet n√°v≈°tƒõv: " +
            this.memory.visits +
            "<br>Posledn√≠ otev≈ôen√≠: " +
            this.memory.lastVisit
          );
        },
      };

      VaFiT.init();

      // ======== CHAT HISTORIE ========
      let chatHistory = loadJson(STORAGE_KEY_CHAT) || [];

      function addMessage(role, content) {
        const msg = {
          role,
          content,
          time: nowTime(),
        };
        chatHistory.push(msg);
        // dr≈æ√≠me t≈ôeba posledn√≠ch 20 zpr√°v
        if (chatHistory.length > 20) {
          chatHistory = chatHistory.slice(chatHistory.length - 20);
        }
        saveJson(STORAGE_KEY_CHAT, chatHistory);
        renderChat();
      }

      function renderChat() {
        const box = document.getElementById("chat-history");
        box.innerHTML = "";
        chatHistory.forEach((m) => {
          const div = document.createElement("div");
          div.className =
            "msg " + (m.role === "user" ? "msg-user" : "msg-vafit");
          const who = m.role === "user" ? "Ty" : "VaF'i'T";
          div.innerHTML =
            "<small>" +
            who +
            " ‚Ä¢ " +
            (m.time || "") +
            "</small><br>" +
            m.content;
          box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;

        // aktualizuj motorovnu podle nov√© historie
        rebuildWorkshopFromChat();
      }

      // ======== WORKSHOP / MOTOROVNA (canvas) ========
      let workshopCanvas = null;
      let workshopCtx = null;
      let workshopNodes = [];
      let workshopInitialized = false;

      function initWorkshop() {
        workshopCanvas = document.getElementById("workshop-canvas");
        if (!workshopCanvas) return;
        workshopCtx = workshopCanvas.getContext("2d");

        function resize() {
          const rect = workshopCanvas.getBoundingClientRect();
          workshopCanvas.width = rect.width;
          workshopCanvas.height = rect.height;
        }
        resize();
        window.addEventListener("resize", resize);
        workshopInitialized = true;
        rebuildWorkshopFromChat();
        workshopLoop();
      }

      function rebuildWorkshopFromChat() {
        if (!workshopInitialized || !workshopCanvas) return;
        workshopNodes = [];

        const max = Math.min(chatHistory.length, 24);
        const startIndex = chatHistory.length - max;
        const rect = workshopCanvas.getBoundingClientRect();
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;

        for (let i = 0; i < max; i++) {
          const msg = chatHistory[startIndex + i];
          const radius = 28 + i * 4;
          const speed = 0.003 + i * 0.0006;
          const angle = i * (Math.PI / 6);
          const isUser = msg.role === "user";

          workshopNodes.push({
            radius,
            speed,
            angle,
            isUser,
          });
        }

        const statusEl = document.getElementById("workshop-status");
        if (statusEl) {
          const last = chatHistory[chatHistory.length - 1];
          if (last) {
            const who = last.role === "user" ? "ty" : "motor";
            const text = (last.content || "")
              .slice(0, 80)
              .replace(/\s+/g, " ");
            statusEl.textContent =
              "Posledn√≠ impuls (" +
              who +
              "): " +
              text +
              (last.content.length > 80 ? "‚Ä¶" : "");
          } else {
            statusEl.textContent = "ƒåek√°m na prvn√≠ impulzy z chatu‚Ä¶";
          }
        }
      }

      function workshopLoop() {
        if (!workshopInitialized || !workshopCtx || !workshopCanvas) {
          requestAnimationFrame(workshopLoop);
          return;
        }

        const rect = workshopCanvas.getBoundingClientRect();
        const w = rect.width;
        const h = rect.height;

        workshopCtx.clearRect(0, 0, w, h);

        // jemn√© pozad√≠
        workshopCtx.globalAlpha = 0.25;
        workshopCtx.fillStyle = "#05060b";
        workshopCtx.fillRect(0, 0, w, h);
        workshopCtx.globalAlpha = 1;

        const cx = w / 2;
        const cy = h / 2;

        // st≈ôedov√Ω "motor"
        workshopCtx.beginPath();
        workshopCtx.arc(cx, cy, 8, 0, Math.PI * 2);
        workshopCtx.fillStyle = "#ffb156";
        workshopCtx.fill();
        workshopCtx.shadowColor = "rgba(255,177,86,0.8)";
        workshopCtx.shadowBlur = 12;

        // orbituj√≠c√≠ uzly
        workshopNodes.forEach((node) => {
          node.angle += node.speed;
          const x = cx + Math.cos(node.angle) * node.radius;
          const y = cy + Math.sin(node.angle) * node.radius;

          // orbitov√° linka (slab√°)
          workshopCtx.beginPath();
          workshopCtx.arc(cx, cy, node.radius, 0, Math.PI * 2);
          workshopCtx.strokeStyle = "rgba(80, 110, 180, 0.18)";
          workshopCtx.lineWidth = 1;
          workshopCtx.stroke();

          // uzel
          workshopCtx.beginPath();
          workshopCtx.arc(x, y, node.isUser ? 3.5 : 4.5, 0, Math.PI * 2);
          workshopCtx.fillStyle = node.isUser ? "#ffdba2" : "#8ec5ff";
          workshopCtx.fill();
        });

        workshopCtx.shadowBlur = 0;
        requestAnimationFrame(workshopLoop);
      }

      // ======== BACKEND CALL ========
      async function sendToVaFiT(messages) {
        const response = await fetch("/api/vafit-chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ messages }),
        });

        const data = await response.json();
        return data.reply;
      }

      // ======== UI INIT ========
      document.addEventListener("DOMContentLoaded", () => {
        initWorkshop();

        document.getElementById("bubble").innerHTML = VaFiT.greeting();
        document.getElementById("summary").innerHTML = VaFiT.summaryHtml();
        document.getElementById("top-sub").textContent =
          "Motor aktivn√≠ ‚Äì lok√°ln√≠ pamƒõ≈• + AI mozek";
        document.getElementById("mood").textContent = VaFiT.moodLabel;

        if (chatHistory.length === 0) {
          addMessage(
            "assistant",
            "Jsem nov√Ω VaF'i'T. Napi≈° mi t≈ôeba, jak√Ω svƒõt chce≈° dneska posunout."
          );
        } else {
          renderChat();
        }

        const input = document.getElementById("vafit-input");
        const sendBtn = document.getElementById("vafit-send");
        const avatar = document.getElementById("avatar");
        const moodEl = document.getElementById("mood");

        async function handleSend() {
          const text = (input.value || "").trim();
          if (!text) return;

          addMessage("user", text);
          input.value = "";
          avatar.classList.add("pulsing");
          VaFiT.updateMoodFromText(text);
          moodEl.textContent = VaFiT.moodLabel;

          try {
            // p≈ôiprav√≠me messages pro backend (jen role + content)
            const backendMessages = chatHistory.map((m) => ({
              role: m.role === "user" ? "user" : "assistant",
              content: m.content,
            }));

            const reply = await sendToVaFiT(backendMessages);
            addMessage("assistant", reply);
          } catch (e) {
            addMessage(
              "assistant",
              "Br√°cho‚Ä¶ spadlo spojen√≠ s motorem. Zkus to je≈°tƒõ jednou."
            );
          } finally {
            avatar.classList.remove("pulsing");
          }
        }

        sendBtn.addEventListener("click", handleSend);
      });
    </script>
  </body>
</html>
